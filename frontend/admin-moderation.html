<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Moderation Dashboard - ConEvents</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-logo">
        ðŸŽ« ConEvents
      </a>
      <ul class="navbar-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="browse.html">Browse</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li id="authLinks">
          <a href="login.html" class="btn btn-primary btn-sm">Login</a>
          <a href="register.html" class="btn btn-primary btn-sm">Sign Up</a>
        </li>
        <li id="userLinks" style="display: none;">
          <span id="welcomeMessage" class="text-muted"></span>
          <div id="adminMenu" class="admin-menu" hidden>
            <button type="button" class="btn btn-secondary btn-sm admin-menu-toggle">
              Admin <span aria-hidden="true" class="admin-menu-caret">&#9662;</span>
            </button>
            <div class="admin-menu-list" role="menu">
              <a href="admin-moderation.html" class="admin-menu-link" role="menuitem">Moderation Dashboard</a>
            </div>
          </div>
          <button type="button" onclick="logout()" class="btn btn-secondary btn-sm">Logout</button>
        </li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <section class="admin-dashboard">
        <header class="dashboard-header">
          <h1>Admin Moderation Dashboard</h1>
          <p class="dashboard-subtitle">
            Review community events, resolve reports, and keep the catalog healthy.
          </p>
        </header>

        <div id="statusMessage" class="status-banner" role="status" aria-live="polite" hidden></div>

        <div class="dashboard-controls">
          <div class="filter-group" role="group" aria-label="Event filter">
            <button type="button" class="btn btn-secondary btn-sm filter-btn active" data-filter="all">
              All events
            </button>
            <button type="button" class="btn btn-secondary btn-sm filter-btn" data-filter="flagged">
              Flagged only
            </button>
          </div>
          <div class="search-group">
            <input id="searchInput" type="search" class="form-control" placeholder="Search by title, category, or location"
              aria-label="Search events" />
          </div>
        </div>

        <div class="card-panel">
          <div id="loadingState" class="loading-state">Loading eventsâ€¦</div>
          <div id="emptyState" class="empty-state" hidden>No events found for the current filters.</div>

          <div class="table-wrapper">
            <table class="moderation-table" aria-describedby="statusMessage">
              <thead>
                <tr>
                  <th scope="col">Event</th>
                  <th scope="col">Schedule</th>
                  <th scope="col">Details</th>
                  <th scope="col">Status</th>
                  <th scope="col" class="actions-column">Actions</th>
                </tr>
              </thead>
              <tbody id="eventsTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Edit Event Modal -->
  <div id="editModal" class="modal-backdrop" hidden role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="editModalTitle">Edit event</h2>
        <button type="button" class="modal-close" data-close-modal aria-label="Close edit dialog">&times;</button>
      </header>
      <form id="editEventForm" class="modal-body">
        <div class="form-grid">
          <label class="form-field">
            <span class="form-label">Title</span>
            <input id="editTitle" name="title" type="text" class="form-control" required />
          </label>
          <label class="form-field">
            <span class="form-label">Event date</span>
            <input id="editDate" name="event_date" type="date" class="form-control" required />
          </label>
          <label class="form-field">
            <span class="form-label">Event time</span>
            <input id="editTime" name="event_time" type="time" class="form-control" required />
          </label>
          <label class="form-field">
            <span class="form-label">Location</span>
            <input id="editLocation" name="location" type="text" class="form-control" required />
          </label>
          <label class="form-field">
            <span class="form-label">Category</span>
            <select id="editCategory" name="category" class="form-control" required>
              <option value="social">Social</option>
              <option value="academic">Academic</option>
              <option value="sports">Sports</option>
              <option value="club">Club</option>
            </select>
          </label>
          <label class="form-field">
            <span class="form-label">Capacity</span>
            <input id="editCapacity" name="capacity" type="number" class="form-control" min="0" />
          </label>
          <label class="form-field">
            <span class="form-label">Price ($)</span>
            <input id="editPrice" name="price" type="number" class="form-control" min="0" step="0.01" />
          </label>
        </div>
        <label class="form-field">
          <span class="form-label">Description</span>
          <textarea id="editDescription" name="description" rows="4" class="form-control"></textarea>
        </label>
        <div id="editFormMessage" class="form-feedback" role="alert" hidden></div>
        <footer class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-close-modal>Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm" id="saveEditButton">Save changes</button>
        </footer>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="confirmModal" class="modal-backdrop" hidden role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="confirmModalTitle">Delete event</h2>
        <button type="button" class="modal-close" data-close-modal aria-label="Close confirmation dialog">&times;</button>
      </header>
      <div class="modal-body">
        <p id="confirmMessage">
          Are you sure you want to delete this event? This action cannot be undone.
        </p>
        <div id="confirmFormMessage" class="form-feedback" role="alert" hidden></div>
      </div>
      <footer class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-close-modal>Cancel</button>
        <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteButton">Delete event</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import { getApiBase, apiFetch } from './utils/api.js';

    const state = {
      filter: 'all',
      events: [],
      editingEventId: null,
      deleteEventId: null,
    };

    const banner = document.getElementById('statusMessage');
    const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('eventsTableBody');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const tableWrapper = document.querySelector('.table-wrapper');
    const cardPanel = document.querySelector('.card-panel');
    const dashboardControls = document.querySelector('.dashboard-controls');
    const adminMenu = document.getElementById('adminMenu');

    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editEventForm');
    const editFormMessage = document.getElementById('editFormMessage');
    const saveEditButton = document.getElementById('saveEditButton');

    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmFormMessage = document.getElementById('confirmFormMessage');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');

    document.addEventListener('DOMContentLoaded', () => {
      if (editModal) closeModal(editModal);
      if (confirmModal) closeModal(confirmModal);
      bootstrapSession();
      attachEventListeners();
    });

    function attachEventListeners() {
      filterButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const nextFilter = btn.dataset.filter || 'all';
          if (state.filter === nextFilter) return;
          state.filter = nextFilter;
          toggleFilterButtons(nextFilter);
          loadEvents();
        });
      });

      searchInput.addEventListener('input', () => {
        renderEvents();
      });

      tableBody.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const action = target.dataset.action;
        const eventId = Number(target.dataset.eventId);
        if (!action || Number.isNaN(eventId)) return;

        if (action === 'edit') {
          openEditModal(eventId);
        } else if (action === 'delete') {
          openDeleteModal(eventId);
        }
      });

      editForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!state.editingEventId) {
          setFormFeedback(editFormMessage, 'Missing event reference. Please try again.', 'error');
          return;
        }

        const payload = buildEditPayload();
        if (!payload.title || !payload.event_date || !payload.event_time || !payload.location || !payload.category) {
          setFormFeedback(editFormMessage, 'Please fill in all required fields.', 'error');
          return;
        }

        try {
          setSubmittingState(true);
          const response = await apiFetch(`/api/admin/events/${state.editingEventId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await safeJson(response);

          if (!response.ok) {
            const message = data?.message || data?.error || 'Unable to update event.';
            setFormFeedback(editFormMessage, message, 'error');
            setStatus(message, 'error');
            return;
          }

          setStatus(data?.message || 'Event updated successfully.', 'success');
          closeModal(editModal);
          await loadEvents();
        } catch (error) {
          console.error('Failed to update event', error);
          const message = 'Unexpected error updating the event. Please try again.';
          setFormFeedback(editFormMessage, message, 'error');
          setStatus(message, 'error');
        } finally {
          setSubmittingState(false);
        }
      });

      confirmDeleteButton.addEventListener('click', async () => {
        if (!state.deleteEventId) {
          setFormFeedback(confirmFormMessage, 'Missing event reference. Please reload and try again.', 'error');
          return;
        }

        try {
          confirmDeleteButton.disabled = true;
          confirmDeleteButton.textContent = 'Deletingâ€¦';
          const response = await apiFetch(`/api/admin/events/${state.deleteEventId}`, {
            method: 'DELETE',
          });
          const data = await safeJson(response);

          if (!response.ok) {
            const message = data?.message || data?.error || 'Unable to delete event.';
            setFormFeedback(confirmFormMessage, message, 'error');
            setStatus(message, 'error');
            return;
          }

          setStatus(data?.message || 'Event deleted successfully.', 'success');
          closeModal(confirmModal);
          await loadEvents();
        } catch (error) {
          console.error('Failed to delete event', error);
          const message = 'Unexpected error deleting the event. Please try again.';
          setFormFeedback(confirmFormMessage, message, 'error');
          setStatus(message, 'error');
        } finally {
          confirmDeleteButton.disabled = false;
          confirmDeleteButton.textContent = 'Delete event';
        }
      });

      document.querySelectorAll('[data-close-modal]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const modal = btn.closest('.modal-backdrop');
          if (modal) closeModal(modal);
        });
      });

      [editModal, confirmModal].forEach((modal) => {
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal(modal);
          }
        });
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (!editModal.hasAttribute('hidden')) closeModal(editModal);
          if (!confirmModal.hasAttribute('hidden')) closeModal(confirmModal);
        }
      });
    }

    async function bootstrapSession() {
      const authLinks = document.getElementById('authLinks');
      const userLinks = document.getElementById('userLinks');
      const welcome = document.getElementById('welcomeMessage');
      const stored = safeParse(localStorage.getItem('user'));
      toggleAdminMenu(false);

      try {
        const resp = await fetch(`${getApiBase()}/api/auth/profile`, { credentials: 'include' });
        if (!resp.ok) {
          if (authLinks) authLinks.style.display = 'flex';
          if (userLinks) userLinks.style.display = 'none';
          if (resp.status === 401) {
            localStorage.removeItem('user');
            setStatus('You need to log in as an administrator to access the moderation dashboard.', 'error');
          } else {
            setStatus('Unable to verify your session. Please try again later.', 'error');
          }
          setLoadingVisibility(false);
          hideDashboardShell();
          toggleAdminMenu(false);
          return;
        }

        const { user } = await resp.json();
        if (userLinks) {
          userLinks.style.display = 'flex';
          userLinks.style.gap = '1rem';
          userLinks.style.alignItems = 'center';
        }
        if (authLinks) authLinks.style.display = 'none';
        if (welcome && user?.name) {
          welcome.textContent = `Welcome, ${user.name}!`;
        }
        localStorage.setItem('user', JSON.stringify(user));

        if (user.role !== 'admin') {
          setStatus('Only administrators can access this dashboard.', 'error');
          hideDashboardShell();
          toggleAdminMenu(false);
          return;
        }

        showDashboardShell();
        toggleAdminMenu(true);
        await loadEvents();
      } catch (error) {
        console.error('Session bootstrap failed', error);
        setStatus('Unable to verify your session right now. Please try again later.', 'error');
        setLoadingVisibility(false);
        hideDashboardShell();
        toggleAdminMenu(false);
        if (stored) {
          if (authLinks) authLinks.style.display = 'none';
          if (userLinks) userLinks.style.display = 'flex';
        }
      }
    }

    async function loadEvents() {
      setLoadingVisibility(true);
      setBannerVisibility(false);
      emptyState.hidden = true;
      tableBody.innerHTML = '';

      const endpoint = state.filter === 'flagged' ? '/api/admin/events/flagged' : '/api/admin/events';

      try {
        const response = await apiFetch(endpoint);
        const data = await safeJson(response);

        if (!response.ok) {
          const message = data?.message || data?.error || 'Failed to retrieve events.';
          setStatus(message, 'error');
          setLoadingVisibility(false);
          emptyState.hidden = false;
          return;
        }

        const list = Array.isArray(data?.events) ? data.events : Array.isArray(data?.flaggedEvents) ? data.flaggedEvents : [];
        state.events = list;
        renderEvents();
      } catch (error) {
        console.error('Failed to load events', error);
        setStatus('Unexpected error fetching events. Please try again.', 'error');
        setLoadingVisibility(false);
        emptyState.hidden = false;
      }
    }

    function renderEvents() {
      const query = searchInput.value.trim().toLowerCase();
      const filtered = state.events.filter((event) => {
        if (!query) return true;
        const composite = [
          event.title,
          event.category,
          event.location,
          event.organization,
          event.moderation_status,
        ]
          .filter(Boolean)
          .map((value) => String(value).toLowerCase())
          .join(' ');
        return composite.includes(query);
      });

      tableBody.innerHTML = '';

      if (filtered.length === 0) {
        setLoadingVisibility(false);
        emptyState.hidden = false;
        return;
      }

      const rows = filtered
        .map((event) => {
          const status = deriveStatus(event);
          return `
            <tr>
              <td>
                <div class="event-primary">
                  <span class="event-title">${escapeHtml(event.title)}</span>
                  <span class="event-id">#${event.id}</span>
                </div>
                <div class="event-description">${escapeHtml(event.description || 'No description provided.')}</div>
              </td>
              <td>
                <div>${formatDate(event.event_date)}</div>
                <div class="event-time">${formatTime(event.event_time)}</div>
              </td>
              <td>
                <div><strong>Location:</strong> ${escapeHtml(event.location || 'â€”')}</div>
                <div><strong>Category:</strong> ${escapeHtml(event.category || 'â€”')}</div>
                <div><strong>Price:</strong> ${formatPrice(event.price)}</div>
                <div><strong>Capacity:</strong> ${formatNumber(event.capacity)}</div>
                <div><strong>Tickets left:</strong> ${formatNumber(event.tickets_available)}</div>
              </td>
              <td>
                <span class="status-badge status-${status.className}">${escapeHtml(status.label)}</span>
                ${status.details ? `<div class="status-subtext">${escapeHtml(status.details)}</div>` : ''}
              </td>
              <td class="actions-column">
                <div class="action-buttons">
                  <button type="button" class="btn btn-secondary btn-sm" data-action="edit" data-event-id="${event.id}">Edit</button>
                  <button type="button" class="btn btn-danger btn-sm" data-action="delete" data-event-id="${event.id}">Delete</button>
                </div>
              </td>
            </tr>
          `;
        })
        .join('');

      tableBody.innerHTML = rows;
      emptyState.hidden = true;
      setLoadingVisibility(false);
    }

    function openEditModal(eventId) {
      const event = state.events.find((item) => Number(item.id) === Number(eventId));
      if (!event) {
        setStatus('Unable to locate that event. It may have been removed.', 'error');
        return;
      }

      state.editingEventId = Number(event.id);
      editForm.reset();
      setFormFeedback(editFormMessage, '', 'info');

      editForm.elements.title.value = event.title || '';
      editForm.elements.event_date.value = formatForDateInput(event.event_date);
      editForm.elements.event_time.value = formatForTimeInput(event.event_time);
      editForm.elements.location.value = event.location || '';
      editForm.elements.category.value = event.category || 'social';
      editForm.elements.capacity.value = event.capacity ?? '';
      editForm.elements.price.value = event.price ?? '';
      editForm.elements.description.value = event.description || '';

      openModal(editModal);
    }

    function openDeleteModal(eventId) {
      const event = state.events.find((item) => Number(item.id) === Number(eventId));
      if (!event) {
        setStatus('Unable to locate that event. It may have been removed.', 'error');
        return;
      }

      state.deleteEventId = Number(event.id);
      setFormFeedback(confirmFormMessage, '', 'info');
      confirmMessage.textContent = `Are you sure you want to delete "${event.title}"? This action cannot be undone.`;

      openModal(confirmModal);
    }

    function buildEditPayload() {
      const payload = {
        title: editForm.elements.title.value.trim(),
        event_date: editForm.elements.event_date.value,
        event_time: editForm.elements.event_time.value,
        location: editForm.elements.location.value.trim(),
        category: editForm.elements.category.value,
        description: editForm.elements.description.value.trim(),
      };

      const capacity = editForm.elements.capacity.value;
      const price = editForm.elements.price.value;

      if (capacity !== '') payload.capacity = Number(capacity);
      if (price !== '') payload.price = Number(price);

      Object.keys(payload).forEach((key) => {
        if (payload[key] === '') delete payload[key];
      });

      return payload;
    }

    function deriveStatus(event) {
      const moderation = event.moderation_status || '';
      const flagged = Boolean(event.is_flagged);

      if (moderation) {
        const normalized = moderation.toString().toLowerCase();
        if (normalized.includes('flag')) {
          return { label: moderation, className: 'alert', details: flagged ? 'Reported by users' : '' };
        }
        if (normalized.includes('pending')) {
          return { label: moderation, className: 'pending', details: 'Awaiting review' };
        }
        if (normalized.includes('rejected')) {
          return { label: moderation, className: 'blocked', details: 'Hidden from listings' };
        }
        if (normalized.includes('approved')) {
          return { label: moderation, className: 'ok', details: flagged ? 'Flag still active' : '' };
        }
      }

      if (flagged) {
        return { label: 'Flagged', className: 'alert', details: 'Reported by users' };
      }

      return { label: 'Active', className: 'ok', details: '' };
    }

    function toggleFilterButtons(selected) {
      filterButtons.forEach((btn) => {
        if ((btn.dataset.filter || 'all') === selected) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    function setStatus(message, variant = 'info') {
      if (!message) {
        setBannerVisibility(false);
        return;
      }

      banner.textContent = message;
      banner.className = `status-banner status-${variant}`;
      setBannerVisibility(true);
    }

    function setFormFeedback(node, message, variant = 'info') {
      if (!node) return;
      if (!message) {
        node.textContent = '';
        node.className = 'form-feedback';
        node.hidden = true;
        return;
      }
      node.hidden = false;
      node.textContent = message;
      node.className = `form-feedback form-feedback-${variant}`;
    }

    function setSubmittingState(isSubmitting) {
      saveEditButton.disabled = isSubmitting;
      saveEditButton.textContent = isSubmitting ? 'Savingâ€¦' : 'Save changes';
    }

    function setBannerVisibility(visible) {
      if (!banner) return;
      banner.hidden = !visible;
      banner.style.display = visible ? 'block' : 'none';
    }

    function setLoadingVisibility(visible) {
      if (!loadingState) return;
      loadingState.style.display = visible ? 'flex' : 'none';
    }

    function toggleAdminMenu(isAdmin) {
      if (!adminMenu) return;
      adminMenu.hidden = !isAdmin;
    }

    function hideDashboardShell() {
      if (tableWrapper) tableWrapper.classList.add('visually-hidden');
      if (cardPanel) cardPanel.classList.add('visually-hidden');
      if (dashboardControls) dashboardControls.classList.add('visually-hidden');
    }

    function showDashboardShell() {
      if (tableWrapper) tableWrapper.classList.remove('visually-hidden');
      if (cardPanel) cardPanel.classList.remove('visually-hidden');
      if (dashboardControls) dashboardControls.classList.remove('visually-hidden');
    }

    function openModal(modal) {
      modal.removeAttribute('hidden');
      document.body.classList.add('modal-open');
    }

    function closeModal(modal) {
      modal.setAttribute('hidden', '');
      if (modal === editModal) {
        state.editingEventId = null;
        setFormFeedback(editFormMessage, '', 'info');
        editForm.reset();
      }
      if (modal === confirmModal) {
        state.deleteEventId = null;
        setFormFeedback(confirmFormMessage, '', 'info');
      }
      if (document.querySelectorAll('.modal-backdrop:not([hidden])').length === 0) {
        document.body.classList.remove('modal-open');
      }
    }

    function safeParse(value) {
      try {
        return value ? JSON.parse(value) : null;
      } catch {
        return null;
      }
    }

    async function safeJson(response) {
      try {
        return await response.json();
      } catch {
        return null;
      }
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDate(value) {
      if (!value) return 'â€”';
      const iso = formatForDateInput(value);
      if (iso) {
        try {
          const date = new Date(`${iso}T00:00:00`);
          return date.toLocaleDateString('en-CA', { year: 'numeric', month: 'short', day: 'numeric' });
        } catch {
          return iso;
        }
      }
      return String(value);
    }

    function formatTime(value) {
      if (!value) return 'â€”';
      const normalized = formatForTimeInput(value);
      if (!normalized) return String(value);
      const [hour, minute] = normalized.split(':');
      const date = new Date();
      date.setHours(Number(hour), Number(minute), 0, 0);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatPrice(value) {
      if (value === null || value === undefined) return '$0.00';
      const number = Number(value);
      if (Number.isNaN(number)) return '$0.00';
      return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(number);
    }

    function formatNumber(value) {
      if (value === null || value === undefined) return 'â€”';
      const number = Number(value);
      return Number.isNaN(number) ? 'â€”' : number.toLocaleString();
    }

    function formatForDateInput(value) {
      if (!value) return '';
      if (typeof value === 'string') {
        if (value.includes('T')) return value.split('T')[0];
        return value;
      }
      if (value instanceof Date) {
        return value.toISOString().split('T')[0];
      }
      return '';
    }

    function formatForTimeInput(value) {
      if (!value) return '';
      if (typeof value === 'string') {
        if (value.includes(':')) return value.slice(0, 5);
        return value;
      }
      return '';
    }

    window.logout = async function logout() {
      try {
        const resp = await fetch(`${getApiBase()}/api/auth/logout`, {
          method: 'POST',
          credentials: 'include',
        });
        localStorage.removeItem('user');
        if (resp.ok) {
          window.location.href = 'index.html';
        } else {
          setStatus('Logout failed. Please try again.', 'error');
        }
      } catch (error) {
        console.warn('Logout failed:', error);
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      }
    };
  </script>
</body>

</html>
