<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Event Moderation - ConEvents</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-logo">üé´ ConEvents</a>
      <ul class="navbar-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="browse.html">Browse</a></li>
        <li><a href="about.html">About</a></li>
        <li id="organizerMenu" class="dropdown" style="display:none;">
          <a href="#" class="dropdown-toggle">Organizer</a>
          <ul class="dropdown-menu">
            <li><a href="organizer-dashboard.html">My Dashboard</a></li>
            <li><a href="organizer-create-event.html">Create Event</a></li>
            <li><a href="organizer-edit-event.html">Edit Event</a></li>
            <li><a href="organizer-analytics.html">Event Analytics</a></li>
            <li><a href="organizer-scanner.html">QR Scanner</a></li>
          </ul>
        </li>
        <li id="adminMenu" style="display:none;"><a href="admin-moderation.html">Admin</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li id="authLinks">
          <a href="login.html" class="btn btn-primary btn-sm">Login</a>
          <a href="register.html" class="btn btn-primary btn-sm">Sign Up</a>
        </li>
        <li id="userLinks" style="display:none;">
          <span id="welcomeMessage" class="text-muted"></span>
          <button onclick="logout()" class="btn btn-secondary btn-sm">Logout</button>
        </li>
      </ul>
    </div>
  </nav>

  <main>
    <div class="main-content">
      <div class="container">
        <section class="hero" style="align-items:flex-start; padding:32px;">
          <div>
            <h1 class="hero-title" style="margin-bottom:8px;">Event Moderation</h1>
            <p class="hero-subtitle" style="max-width:560px;">
              Review, update, and moderate events submitted by organizers. Use the filters to focus on flagged or pending listings.
            </p>
          </div>
          <div style="display:flex; gap:12px; align-items:center;">
            <a href="javascript:history.back()" class="btn btn-secondary btn-sm">‚Üê Back</a>
            <button id="refreshBtn" class="btn btn-primary btn-sm" type="button">Refresh</button>
          </div>
        </section>

        <div class="moderation-wrapper">
          <div class="breadcrumbs"><span>Admin</span> <span>‚Ä∫</span> <span>Moderation</span></div>
          <div class="moderation-toolbar">
            <div class="filters" role="tablist" aria-label="Moderation filters">
              <button class="moderation-filter active" data-filter="all" type="button">All Events</button>
              <button class="moderation-filter" data-filter="flagged" type="button">Flagged</button>
              <button class="moderation-filter" data-filter="pending" type="button">Pending Review</button>
            </div>
            <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
              <input id="searchInput" type="search" placeholder="Search title, organizer, or location" aria-label="Search events">
            </div>
          </div>

          <div class="moderation-layout single">
            <section class="moderation-card" aria-label="Event moderation table">
              <table class="moderation-table">
                <thead>
                  <tr>
                    <th scope="col">Event</th>
                    <th scope="col">Date</th>
                    <th scope="col">Location</th>
                    <th scope="col">Status</th>
                    <th scope="col">Flags</th>
                    <th scope="col" style="width:110px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="eventsTableBody">
                  <tr>
                    <td colspan="6" class="empty-state">Loading events‚Ä¶</td>
                  </tr>
                </tbody>
              </table>
            </section>

            <aside class="moderation-card moderation-detail" id="eventDetailPanel" style="display:none;" aria-live="polite">
              <div>
                <h2 id="detailTitle" style="margin:0 0 6px; font-size:1.4rem;">Select an event</h2>
                <p id="detailSubtitle" style="margin:0; color:#6b7280;">Choose an event from the table to view details and take action.</p>
              </div>

              <div id="detailGrid" class="detail-grid" style="display:none;">
                <div class="detail-item">
                  <span>Organizer</span>
                  <strong id="detailOrganizer">‚Äî</strong>
                </div>
                <div class="detail-item">
                  <span>Moderation Status</span>
                  <strong id="detailStatus">‚Äî</strong>
                </div>
                <div class="detail-item">
                  <span>Category</span>
                  <strong id="detailCategory">‚Äî</strong>
                </div>
                <div class="detail-item">
                  <span>Tickets</span>
                  <strong id="detailTickets">‚Äî</strong>
                </div>
                <div class="detail-item">
                  <span>Price</span>
                  <strong id="detailPrice">‚Äî</strong>
                </div>
                <div class="detail-item">
                  <span>Flag Count</span>
                  <strong id="detailFlags">‚Äî</strong>
                </div>
              </div>

              <article class="detail-item" style="background:#fff; border:1px solid #e5e7eb; display:none;" id="detailDescriptionCard">
                <span style="color:#64748b;">Description</span>
                <p id="detailDescription" style="margin:8px 0 0; color:#1f2937; line-height:1.5;"></p>
              </article>

              <div class="action-buttons" id="detailActions" style="display:none;">
                <button id="openEditBtn" class="btn btn-primary" type="button">Edit Event</button>
                <button id="openDeleteBtn" class="btn btn-secondary" type="button" style="background:#fff; color:#b91c1c; border:1px solid #fee2e2;">Delete Event</button>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-links">
      <a href="about.html">About Us</a>
      <a href="browse.html">Events</a>
      <a href="privacy.html">Privacy Policy</a>
      <a href="terms.html">Terms of Service</a>
      <a href="contact.html">Contact</a>
    </div>
    <p>&copy; 2025 ConEvents - Concordia University. All rights reserved.</p>
  </footer>

  <div class="toast-container" id="toastContainer" aria-live="assertive"></div>

  <dialog id="editDialog" class="moderation-dialog" aria-labelledby="editDialogTitle">
    <header>
      <h3 id="editDialogTitle">Edit Event</h3>
    </header>
    <form id="editForm">
      <label for="editTitle">Title</label>
      <input id="editTitle" name="title" type="text" required />

      <label for="editDescription">Description</label>
      <textarea id="editDescription" name="description"></textarea>

      <label for="editLocation">Location</label>
      <input id="editLocation" name="location" type="text" required />

      <label for="editStatus">Moderation Status</label>
      <select id="editStatus" name="moderation_status">
        <option value="approved">Approved</option>
        <option value="pending">Pending</option>
        <option value="rejected">Rejected</option>
      </select>

      <footer>
        <button type="button" class="btn btn-secondary btn-sm" data-action="close">Cancel</button>
        <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
      </footer>
    </form>
  </dialog>

  <dialog id="deleteDialog" class="moderation-dialog" aria-labelledby="deleteDialogTitle">
    <header>
      <h3 id="deleteDialogTitle">Delete Event</h3>
    </header>
    <form id="deleteForm">
      <p id="deletePrompt" style="margin:0; color:#4b5563;">Are you sure you want to delete this event? This action cannot be undone.</p>
      <footer>
        <button type="button" class="btn btn-secondary btn-sm" data-action="close">Cancel</button>
        <button type="submit" class="btn btn-primary btn-sm" style="background:#b91c1c;">Delete</button>
      </footer>
    </form>
  </dialog>

  <script type="module">
    import { getApiBase, apiFetch } from './utils/api.js';

    const state = {
      events: [],
      filtered: [],
      selectedId: null,
      isLoading: false,
      filter: 'all',
      editingId: null,
      deletingId: null,
    };

    const elements = {
      organizerMenu: document.getElementById('organizerMenu'),
      adminMenu: document.getElementById('adminMenu'),
      authLinks: document.getElementById('authLinks'),
      userLinks: document.getElementById('userLinks'),
      welcomeMessage: document.getElementById('welcomeMessage'),
      layout: document.querySelector('.moderation-layout'),
      filterButtons: document.querySelectorAll('.moderation-filter'),
      searchInput: document.getElementById('searchInput'),
      refreshBtn: document.getElementById('refreshBtn'),
      tableBody: document.getElementById('eventsTableBody'),
      detailPanel: document.getElementById('eventDetailPanel'),
      detailGrid: document.getElementById('detailGrid'),
      detailDescriptionCard: document.getElementById('detailDescriptionCard'),
      detailActions: document.getElementById('detailActions'),
      detailTitle: document.getElementById('detailTitle'),
      detailSubtitle: document.getElementById('detailSubtitle'),
      detailOrganizer: document.getElementById('detailOrganizer'),
      detailStatus: document.getElementById('detailStatus'),
      detailCategory: document.getElementById('detailCategory'),
      detailTickets: document.getElementById('detailTickets'),
      detailPrice: document.getElementById('detailPrice'),
      detailFlags: document.getElementById('detailFlags'),
      detailDescription: document.getElementById('detailDescription'),
      openEditBtn: document.getElementById('openEditBtn'),
      openDeleteBtn: document.getElementById('openDeleteBtn'),
      editDialog: document.getElementById('editDialog'),
      editForm: document.getElementById('editForm'),
      editTitle: document.getElementById('editTitle'),
      editDescription: document.getElementById('editDescription'),
      editLocation: document.getElementById('editLocation'),
      editStatus: document.getElementById('editStatus'),
      deleteDialog: document.getElementById('deleteDialog'),
      deleteForm: document.getElementById('deleteForm'),
      deletePrompt: document.getElementById('deletePrompt'),
      toastContainer: document.getElementById('toastContainer'),
    };

    async function handleLogout() {
      try {
        const response = await fetch(`${getApiBase()}/api/auth/logout`, {
          method: 'POST',
          credentials: 'include',
        });

        if (!response.ok) {
          showToast('error', 'Could not log out. Please try again.');
          return;
        }
      } catch (error) {
        console.error('Logout failed:', error);
        showToast('error', 'Network error logging out.');
        return;
      }

      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    window.logout = handleLogout;

    async function initializeModerationDashboard() {
      updateAuthNavigation();
      bindUIEvents();
      renderLoadingState();
      await loadEvents();
    }

    function updateAuthNavigation() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const isOrganizer = user && String(user.role || '').toLowerCase() === 'organizer';
        const isAdmin = user && String(user.role || '').toLowerCase() === 'admin';

        if (elements.organizerMenu) elements.organizerMenu.style.display = isOrganizer ? '' : 'none';
        if (elements.adminMenu) elements.adminMenu.style.display = isAdmin ? '' : 'none';

        if (user) {
          elements.authLinks.style.display = 'none';
          elements.userLinks.style.display = 'flex';
          elements.userLinks.style.gap = '1rem';
          elements.userLinks.style.alignItems = 'center';
          elements.welcomeMessage.textContent = `Welcome, ${user.name}!`;
        } else {
          elements.authLinks.style.display = '';
          elements.userLinks.style.display = 'none';
          elements.welcomeMessage.textContent = '';
        }
      } catch (error) {
        console.error('Failed to update auth navigation', error);
      }
    }

    function getSelectedEvent() {
      if (!state.selectedId) return null;
      return state.events.find((event) => event.id === state.selectedId) || null;
    }

    function openEditDialog(eventData) {
      if (!elements.editDialog) return;
      state.editingId = eventData.id;

      if (elements.editTitle) elements.editTitle.value = eventData.title || '';
      if (elements.editDescription) elements.editDescription.value = eventData.description || '';
      if (elements.editLocation) elements.editLocation.value = eventData.location || '';
      if (elements.editStatus) elements.editStatus.value = eventData.moderation_status || 'pending';

      try {
        elements.editDialog.showModal();
      } catch (error) {
        elements.editDialog.setAttribute('open', '');
      }
    }

    function closeEditDialog() {
      state.editingId = null;
      if (elements.editForm) elements.editForm.reset();
      if (elements.editDialog && elements.editDialog.open) {
        elements.editDialog.close();
      } else if (elements.editDialog) {
        elements.editDialog.removeAttribute('open');
      }
    }

    function openDeleteDialog(eventData) {
      if (!elements.deleteDialog) return;
      state.deletingId = eventData.id;

      if (elements.deletePrompt) {
        elements.deletePrompt.textContent = `Are you sure you want to delete "${eventData.title || 'this event'}"? This action cannot be undone.`;
      }

      try {
        elements.deleteDialog.showModal();
      } catch (error) {
        elements.deleteDialog.setAttribute('open', '');
      }
    }

    function closeDeleteDialog() {
      state.deletingId = null;
      if (elements.deleteDialog && elements.deleteDialog.open) {
        elements.deleteDialog.close();
      } else if (elements.deleteDialog) {
        elements.deleteDialog.removeAttribute('open');
      }
    }

    async function handleEditSubmit(event) {
      event.preventDefault();
      const targetId = state.editingId || state.selectedId;
      if (!targetId) {
        showToast('error', 'No event selected to edit.');
        return;
      }

      const payload = {
        title: (elements.editTitle?.value || '').trim(),
        description: (elements.editDescription?.value || '').trim(),
        location: (elements.editLocation?.value || '').trim(),
        moderation_status: elements.editStatus?.value || 'pending',
      };

      const submitButton = elements.editForm?.querySelector('button[type="submit"]');
      if (submitButton) submitButton.disabled = true;

      try {
        const response = await apiFetch(`/api/admin/events/${targetId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        let data = {};
        try {
          data = await response.json();
        } catch (_) {
          data = {};
        }

        if (!response.ok || data?.success === false) {
          const message = data?.error || data?.message || 'Failed to update event.';
          throw new Error(message);
        }

        const existing = state.events.find((evt) => evt.id === targetId) || {};
        const merged = data.event ? { ...existing, ...data.event } : { ...existing, ...payload };
        const normalized = normalizeEvent(merged);

        state.events = state.events.map((evt) => (evt.id === normalized.id ? normalized : evt));
        const stillVisible = isEventVisible(normalized);
        applyFilters();
        if (stillVisible) {
          selectEvent(normalized);
        } else {
          clearDetailPanel();
        }
        showToast('success', data?.message || 'Event updated successfully.');
        closeEditDialog();
      } catch (error) {
        console.error('Failed to update event:', error);
        showToast('error', error.message || 'Unable to update event.');
      } finally {
        if (submitButton) submitButton.disabled = false;
      }
    }

    async function handleDeleteSubmit(event) {
      event.preventDefault();
      const targetId = state.deletingId || state.selectedId;
      if (!targetId) {
        showToast('error', 'No event selected to delete.');
        return;
      }

      const submitButton = elements.deleteForm?.querySelector('button[type="submit"]');
      if (submitButton) submitButton.disabled = true;

      try {
        const response = await apiFetch(`/api/admin/events/${targetId}`, {
          method: 'DELETE',
        });

        let data = {};
        try {
          data = await response.json();
        } catch (_) {
          data = {};
        }

        if (!response.ok || data?.success === false) {
          const message = data?.error || data?.message || 'Failed to delete event.';
          throw new Error(message);
        }

        state.events = state.events.filter((evt) => evt.id !== targetId);
        if (state.selectedId === targetId) {
          clearDetailPanel();
        }
        closeDeleteDialog();
        applyFilters();
        showToast('success', data?.message || 'Event deleted successfully.');
      } catch (error) {
        console.error('Failed to delete event:', error);
        showToast('error', error.message || 'Unable to delete event.');
      } finally {
        if (submitButton) submitButton.disabled = false;
      }
    }

    function bindUIEvents() {
      elements.filterButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const nextFilter = button.dataset.filter || 'all';
          if (state.filter === nextFilter) return;
          state.filter = nextFilter;
          elements.filterButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
          applyFilters();
        });
      });

      let searchTimer = null;
      elements.searchInput.addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(applyFilters, 180);
      });

      elements.refreshBtn.addEventListener('click', () => {
        loadEvents();
      });

      elements.tableBody.addEventListener('click', (event) => {
        const row = event.target.closest('tr[data-event-id]');
        if (!row) return;
        const eventId = Number(row.dataset.eventId);
        const selected = state.events.find((entry) => entry.id === eventId);
        if (selected) {
          selectEvent(selected);
        }
      });

      if (elements.openEditBtn) {
        elements.openEditBtn.addEventListener('click', () => {
          const current = getSelectedEvent();
          if (!current) {
            showToast('error', 'Select an event to edit.');
            return;
          }
          openEditDialog(current);
        });
      }

      if (elements.openDeleteBtn) {
        elements.openDeleteBtn.addEventListener('click', () => {
          const current = getSelectedEvent();
          if (!current) {
            showToast('error', 'Select an event to delete.');
            return;
          }
          openDeleteDialog(current);
        });
      }

      if (elements.editForm) {
        elements.editForm.addEventListener('submit', handleEditSubmit);
        elements.editForm.addEventListener('click', (event) => {
          const closeBtn = event.target.closest('[data-action="close"]');
          if (closeBtn) {
            event.preventDefault();
            closeEditDialog();
          }
        });
      }

      if (elements.deleteForm) {
        elements.deleteForm.addEventListener('submit', handleDeleteSubmit);
        elements.deleteForm.addEventListener('click', (event) => {
          const closeBtn = event.target.closest('[data-action="close"]');
          if (closeBtn) {
            event.preventDefault();
            closeDeleteDialog();
          }
        });
      }

      if (elements.editDialog) {
        elements.editDialog.addEventListener('cancel', (event) => {
          event.preventDefault();
          closeEditDialog();
        });
      }

      if (elements.deleteDialog) {
        elements.deleteDialog.addEventListener('cancel', (event) => {
          event.preventDefault();
          closeDeleteDialog();
        });
      }
    }

    async function loadEvents() {
      state.isLoading = true;
      renderLoadingState();
      try {
        const response = await apiFetch('/api/admin/events');
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        const payload = await response.json();
        const events = extractEventsFromPayload(payload);
        state.events = events.map(normalizeEvent);
        applyFilters();
        if (!state.events.length) {
          clearDetailPanel();
          renderEmptyState('No events found yet. Once organizers submit events, they will appear here.');
        }
      } catch (error) {
        console.error('Failed to load moderation events:', error);
        clearDetailPanel();
        renderEmptyState('Unable to load events. Please try refreshing or check back later.');
        showToast('error', 'Could not load events. Please try again.');
      } finally {
        state.isLoading = false;
      }
    }

    function extractEventsFromPayload(payload) {
      if (!payload) return [];
      if (Array.isArray(payload)) return payload;
      if (Array.isArray(payload.events)) return payload.events;
      if (Array.isArray(payload.data)) return payload.data;
      return [];
    }

    function normalizeEvent(raw = {}) {
      const id = Number(raw.id ?? raw.event_id ?? raw.ID ?? 0);
      const title = raw.title || raw.event_title || 'Untitled Event';
      const description = raw.description || raw.event_description || '';
      const eventDate = raw.event_date || raw.date || null;
      const eventTime = raw.event_time || raw.time || null;
      const location = raw.location || raw.venue || 'TBD';
      const category = (raw.category || raw.event_category || '').toString();
      const organizerName = raw.organizer_name || raw.organizer || raw.created_by || 'Unknown organizer';
      const organization = raw.organization || raw.organizer_organization || '';
      const capacity = Number(raw.capacity ?? raw.max_attendees ?? 0);
      const ticketsAvailable = Number(raw.tickets_available ?? raw.remaining_tickets ?? 0);
      const price = Number(raw.price ?? raw.ticket_price ?? 0);

      const statusRaw = (raw.moderation_status || raw.status || raw.review_status || 'pending').toString().toLowerCase();
      const moderationStatus = normalizeStatus(statusRaw);

      const rawFlagCount = raw.flag_count ?? raw.flags ?? raw.flagged_count ?? raw.report_count ?? 0;
      const flagCount = Number(rawFlagCount) || 0;
      const flagged = determineFlaggedState(raw, flagCount);

      return {
        ...raw,
        id,
        title,
        description,
        event_date: eventDate,
        event_time: eventTime,
        location,
        category,
        organizer_name: organizerName,
        organization,
        capacity,
        tickets_available: ticketsAvailable,
        price,
        moderation_status: moderationStatus,
        flag_count: flagCount,
        is_flagged: flagged,
      };
    }

    function normalizeStatus(status) {
      const value = status || '';
      if (['approved', 'active', 'published'].includes(value)) return 'approved';
      if (['rejected', 'blocked', 'removed'].includes(value)) return 'rejected';
      return 'pending';
    }

    function determineFlaggedState(event, flagCount) {
      const rawFlag = event.flagged ?? event.is_flagged ?? event.reported ?? event.is_flagged === 1;
      if (typeof rawFlag === 'string') {
        return ['true', '1', 'yes', 'flagged'].includes(rawFlag.toLowerCase());
      }
      if (typeof rawFlag === 'number') {
        return rawFlag > 0;
      }
      if (typeof rawFlag === 'boolean') {
        return rawFlag;
      }
      return flagCount > 0;
    }

    function isEventVisible(event, searchTermOverride) {
      const effectiveSearch =
        typeof searchTermOverride === 'string'
          ? searchTermOverride
          : (elements.searchInput.value || '').trim().toLowerCase();

      if (!filterMatches(event, state.filter)) {
        return false;
      }

      if (!effectiveSearch) {
        return true;
      }

      return matchesSearch(event, effectiveSearch);
    }

    function applyFilters() {
      if (!state.events.length) {
        renderEmptyState(state.isLoading ? 'Loading events‚Ä¶' : 'No events found.');
        return;
      }

      const searchTerm = (elements.searchInput.value || '').trim().toLowerCase();

      state.filtered = state.events.filter((event) => isEventVisible(event, searchTerm));

      if (state.selectedId && !state.filtered.some((event) => event.id === state.selectedId)) {
        clearDetailPanel();
      }

      renderTable();
    }

    function filterMatches(event, filter) {
      switch (filter) {
        case 'flagged':
          return Boolean(event.is_flagged);
        case 'pending':
          return event.moderation_status === 'pending';
        default:
          return true;
      }
    }

    function matchesSearch(event, searchTerm) {
      const haystacks = [
        event.title,
        event.location,
        event.category,
        event.organizer_name,
        event.organization,
        event.moderation_status,
      ];
      return haystacks
        .filter(Boolean)
        .some((field) => field.toString().toLowerCase().includes(searchTerm));
    }

    function renderTable() {
      if (!state.filtered.length) {
        clearDetailPanel();
        renderEmptyState('No events match the current filters.');
        return;
      }

      elements.tableBody.innerHTML = state.filtered.map(renderTableRow).join('');
      ensureDetailPanelVisibility(Boolean(state.selectedId));
      highlightSelectedRow();
    }

    function renderTableRow(event) {
      const { id, title, moderation_status, is_flagged, flag_count, organizer_name } = event;
      const dateLabel = formatEventDate(event.event_date, event.event_time);
      const statusPill = renderStatusPill(moderation_status, is_flagged);
      const flagsLabel = flag_count > 0 ? `${flag_count}` : '0';

      return `
        <tr data-event-id="${id}" class="${state.selectedId === id ? 'is-selected' : ''}">
          <td>
            <div style="font-weight:600; color:#111827;">${escapeHtml(title)}</div>
            <div class="small-muted">${escapeHtml(organizer_name || 'Unassigned')}</div>
          </td>
          <td>${dateLabel}</td>
          <td>${escapeHtml(event.location || 'TBD')}</td>
          <td>${statusPill}</td>
          <td style="font-weight:600; color:${flag_count > 0 ? '#b91c1c' : '#64748b'};">${flagsLabel}</td>
          <td><button type="button" class="btn btn-secondary btn-sm" data-action="view">View</button></td>
        </tr>
      `;
    }

    function selectEvent(event) {
      state.selectedId = event.id;
      highlightSelectedRow();
      populateDetailPanel(event);
    }

    function highlightSelectedRow() {
      const rows = elements.tableBody.querySelectorAll('tr[data-event-id]');
      rows.forEach((row) => {
        const rowId = Number(row.dataset.eventId);
        row.classList.toggle('is-selected', rowId === state.selectedId);
      });
    }

    function populateDetailPanel(event) {
      if (!event) {
        clearDetailPanel();
        return;
      }

      elements.detailTitle.textContent = event.title || 'Event Details';
      elements.detailSubtitle.textContent = buildDetailSubtitle(event);
      elements.detailOrganizer.textContent = event.organizer_name || 'Unknown organizer';
      elements.detailStatus.textContent = formatStatusLabel(event.moderation_status, event.is_flagged);
      elements.detailCategory.textContent = event.category || '‚Äî';
      elements.detailTickets.textContent = `${event.tickets_available ?? 0} / ${event.capacity ?? 0}`;
      elements.detailPrice.textContent = formatCurrency(event.price);
      elements.detailFlags.textContent = event.flag_count ?? 0;
      elements.detailDescription.textContent = event.description || 'No description provided.';

      elements.detailGrid.style.display = 'grid';
      elements.detailDescriptionCard.style.display = 'block';
      elements.detailActions.style.display = 'flex';
      ensureDetailPanelVisibility(true);
    }

    function clearDetailPanel() {
      elements.detailTitle.textContent = 'Select an event';
      elements.detailSubtitle.textContent = 'Choose an event from the table to view details and take action.';
      elements.detailGrid.style.display = 'none';
      elements.detailDescriptionCard.style.display = 'none';
      elements.detailActions.style.display = 'none';
      ensureDetailPanelVisibility(false);
      state.selectedId = null;
      highlightSelectedRow();
    }

    function ensureDetailPanelVisibility(shouldShow) {
      if (!elements.detailPanel) return;
      elements.detailPanel.style.display = shouldShow ? 'flex' : 'none';
      if (elements.layout) {
        elements.layout.classList.toggle('single', !shouldShow);
      }
    }

    function renderLoadingState() {
      elements.tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="empty-state">Loading events‚Ä¶</td>
        </tr>
      `;
      ensureDetailPanelVisibility(false);
    }

    function renderEmptyState(message = 'Select a filter to begin reviewing events.') {
      elements.tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="empty-state">${message}</td>
        </tr>
      `;
      ensureDetailPanelVisibility(false);
    }

    function renderStatusPill(status, isFlagged) {
      const base = status || 'pending';
      const flagSuffix = isFlagged ? ' flagged' : '';
      return `<span class="status-pill ${base}${flagSuffix}">${formatStatusLabel(base, isFlagged)}</span>`;
    }

    function formatStatusLabel(status, isFlagged) {
      const value = status || 'pending';
      if (value === 'approved') return isFlagged ? 'Approved ¬∑ Flagged' : 'Approved';
      if (value === 'rejected') return 'Rejected';
      return isFlagged ? 'Pending ¬∑ Flagged' : 'Pending Review';
    }

    function buildDetailSubtitle(event) {
      const dateLabel = formatEventDate(event.event_date, event.event_time);
      const location = event.location ? ` ¬∑ ${event.location}` : '';
      return `${dateLabel}${location}`;
    }

    function formatEventDate(date, time) {
      const formattedDate = formatDate(date);
      const formattedTime = formatTime(time);
      if (formattedDate && formattedTime) return `${formattedDate} ¬∑ ${formattedTime}`;
      return formattedDate || formattedTime || 'TBD';
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) return dateString;
        return new Intl.DateTimeFormat('en-CA', { month: 'short', day: 'numeric', year: 'numeric' }).format(date);
      } catch {
        return dateString;
      }
    }

    function formatTime(timeString) {
      if (!timeString) return '';
      try {
        const [hours = '0', minutes = '0'] = timeString.split(':');
        const date = new Date();
        date.setHours(Number(hours), Number(minutes));
        return new Intl.DateTimeFormat('en-CA', { hour: 'numeric', minute: '2-digit' }).format(date);
      } catch {
        return timeString;
      }
    }

    function formatCurrency(amount) {
      const value = Number(amount) || 0;
      return value === 0 ? 'Free' : new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(value);
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return value
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function showToast(type, message) {
      if (!elements.toastContainer) return;
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      elements.toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 220);
      }, 3200);
    }

    document.addEventListener('DOMContentLoaded', initializeModerationDashboard);
  </script>
</body>
</html>
