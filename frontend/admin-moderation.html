<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Event Moderation - ConEvents</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="index.html" class="navbar-logo">ðŸŽ« ConEvents</a>
      <ul class="navbar-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="browse.html">Browse</a></li>
        <li><a href="about.html">About</a></li>
        <li id="adminMenu" class="dropdown" style="display:none;">
          <a href="#" class="dropdown-toggle">Admin</a>
          <ul class="dropdown-menu">
            <li><a href="admin-moderation.html">Event Moderation</a></li>
          </ul>
        </li>
        <li><a href="profile.html">Profile</a></li>
        <li id="authLinks">
          <a href="login.html" class="btn btn-primary btn-sm">Login</a>
          <a href="register.html" class="btn btn-primary btn-sm">Sign Up</a>
        </li>
        <li id="userLinks" style="display:none;">
          <span id="welcomeMessage" class="text-muted"></span>
          <button onclick="logout()" class="btn btn-secondary btn-sm">Logout</button>
        </li>
      </ul>
    </div>
  </nav>

  <main>
    <div class="main-content">
      <div class="container">
        <section class="hero" style="align-items:flex-start; padding:32px;">
          <div>
            <h1 class="hero-title" style="margin-bottom:8px;">Event Moderation Dashboard</h1>
            <p class="hero-subtitle" style="max-width:620px;">
              Review, edit, and moderate events submitted by organizers. Approve changes and keep listings accurate.
            </p>
          </div>
        </section>

        <div class="moderation-wrapper">
          <header class="moderation-toolbar">
            <div class="filters" role="tablist" aria-label="Moderation filters">
              <button class="moderation-filter active" data-filter="all" type="button">All Events</button>
              <button class="moderation-filter" data-filter="flagged" type="button">Flagged</button>
              <button class="moderation-filter" data-filter="pending" type="button">Pending Review</button>
            </div>
            <div style="margin-left:auto;">
              <input id="searchInput" type="search" placeholder="Search title, organizer, or location" aria-label="Search events" />
            </div>
            <button id="refreshBtn" class="btn btn-primary btn-sm" type="button">Refresh</button>
          </header>

          <div class="moderation-layout single">
            <section class="moderation-card">
              <table class="moderation-table">
                <thead>
                  <tr>
                    <th>Event</th>
                    <th>Date</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Flags</th>
                    <th style="width:140px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="eventsTableBody">
                  <tr><td colspan="6" class="empty-state">Loading eventsâ€¦</td></tr>
                </tbody>
              </table>
            </section>

            <aside class="moderation-card moderation-detail" id="eventDetailPanel" style="display:none;">
              <header>
                <h2 id="detailTitle" style="margin:0;">Select an event</h2>
                <p id="detailSubtitle" class="small-muted">Choose an event in the table to view full details.</p>
              </header>
              <div id="detailGrid" class="detail-grid" style="display:none;">
                <div class="detail-item">
                  <span>Organizer</span>
                  <strong id="detailOrganizer">â€”</strong>
                </div>
                <div class="detail-item">
                  <span>Status</span>
                  <strong id="detailStatus">â€”</strong>
                </div>
                <div class="detail-item">
                  <span>Category</span>
                  <strong id="detailCategory">â€”</strong>
                </div>
                <div class="detail-item">
                  <span>Tickets</span>
                  <strong id="detailTickets">â€”</strong>
                </div>
                <div class="detail-item">
                  <span>Price</span>
                  <strong id="detailPrice">â€”</strong>
                </div>
                <div class="detail-item">
                  <span>Flag Count</span>
                  <strong id="detailFlags">â€”</strong>
                </div>
              </div>
              <article id="detailDescriptionCard" class="detail-item" style="display:none;">
                <span>Description</span>
                <p id="detailDescription" style="margin:0;"></p>
              </article>
              <div id="detailActions" class="action-buttons" style="display:none;">
                <button id="openEditBtn" class="btn btn-primary" type="button">Edit Event</button>
                <button id="openDeleteBtn" class="btn btn-secondary" type="button">Delete Event</button>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-links">
      <a href="about.html">About Us</a>
      <a href="browse.html">Events</a>
      <a href="privacy.html">Privacy Policy</a>
      <a href="terms.html">Terms of Service</a>
      <a href="contact.html">Contact</a>
    </div>
    <p>&copy; 2025 ConEvents - Concordia University. All rights reserved.</p>
  </footer>

  <div class="toast-container" id="toastContainer" aria-live="assertive"></div>

  <dialog id="editDialog" class="moderation-dialog" aria-labelledby="editDialogTitle">
    <form id="editForm">
      <header>
        <h3 id="editDialogTitle">Edit Event</h3>
      </header>
      <div class="dialog-body">
        <label for="editTitle">Title</label>
        <input id="editTitle" name="title" type="text" required />

        <label for="editDescription">Description</label>
        <textarea id="editDescription" name="description" rows="4"></textarea>

        <label for="editLocation">Location</label>
        <input id="editLocation" name="location" type="text" required />

        <label for="editStatus">Moderation Status</label>
        <select id="editStatus" name="moderation_status">
          <option value="approved">Approved</option>
          <option value="pending">Pending</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <footer>
        <button type="button" class="btn btn-secondary btn-sm" data-action="close">Cancel</button>
        <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
      </footer>
    </form>
  </dialog>

  <dialog id="deleteDialog" class="moderation-dialog" aria-labelledby="deleteDialogTitle">
    <form id="deleteForm">
      <header>
        <h3 id="deleteDialogTitle">Delete Event?</h3>
      </header>
      <div class="dialog-body">
        <p id="deletePrompt" class="muted">Are you sure you want to delete this event? This action cannot be undone.</p>
      </div>
      <footer>
        <button type="button" class="btn btn-secondary btn-sm" data-action="close">Cancel</button>
        <button type="submit" class="btn btn-secondary btn-sm" style="background:#b91c1c;">Delete</button>
      </footer>
    </form>
  </dialog>

  <script type="module">
    import { getApiBase, apiFetch } from './utils/api.js';

    const state = {
      events: [],
      filtered: [],
      selectedId: null,
      filter: 'all',
      isLoading: false,
    };

    const elements = {
      adminMenu: document.getElementById('adminMenu'),
      authLinks: document.getElementById('authLinks'),
      userLinks: document.getElementById('userLinks'),
      welcomeMessage: document.getElementById('welcomeMessage'),
      tableBody: document.getElementById('eventsTableBody'),
      filterButtons: document.querySelectorAll('.moderation-filter'),
      searchInput: document.getElementById('searchInput'),
      refreshBtn: document.getElementById('refreshBtn'),
      detailPanel: document.getElementById('eventDetailPanel'),
      detailTitle: document.getElementById('detailTitle'),
      detailSubtitle: document.getElementById('detailSubtitle'),
      detailGrid: document.getElementById('detailGrid'),
      detailDescriptionCard: document.getElementById('detailDescriptionCard'),
      detailDescription: document.getElementById('detailDescription'),
      detailOrganizer: document.getElementById('detailOrganizer'),
      detailStatus: document.getElementById('detailStatus'),
      detailCategory: document.getElementById('detailCategory'),
      detailTickets: document.getElementById('detailTickets'),
      detailPrice: document.getElementById('detailPrice'),
      detailFlags: document.getElementById('detailFlags'),
      detailActions: document.getElementById('detailActions'),
      editDialog: document.getElementById('editDialog'),
      editForm: document.getElementById('editForm'),
      editTitle: document.getElementById('editTitle'),
      editDescription: document.getElementById('editDescription'),
      editLocation: document.getElementById('editLocation'),
      editStatus: document.getElementById('editStatus'),
      openEditBtn: document.getElementById('openEditBtn'),
      deleteDialog: document.getElementById('deleteDialog'),
      deleteForm: document.getElementById('deleteForm'),
      deletePrompt: document.getElementById('deletePrompt'),
      openDeleteBtn: document.getElementById('openDeleteBtn'),
      toastContainer: document.getElementById('toastContainer'),
    };

    function updateAuthNavigation() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const isAdmin = user && String(user.role || '').toLowerCase() === 'admin';

        if (user) {
          elements.authLinks.style.display = 'none';
          elements.userLinks.style.display = 'flex';
          elements.userLinks.style.gap = '1rem';
          elements.userLinks.style.alignItems = 'center';
          elements.welcomeMessage.textContent = `Welcome, ${user.name}!`;
        }

        if (elements.adminMenu) elements.adminMenu.style.display = isAdmin ? '' : 'none';
      } catch (error) {
        console.warn('Auth nav update failed:', error);
      }
    }

    async function handleLogout() {
      try {
        const resp = await fetch(`${getApiBase()}/api/auth/logout`, {
          method: 'POST',
          credentials: 'include',
        });

        if (!resp.ok) {
          showToast('Could not log out. Please try again.', 'error');
          return;
        }
      } catch (error) {
        showToast('Network error logging out.', 'error');
        return;
      }

      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    window.logout = handleLogout;

    function showToast(message, type = 'success') {
      if (!elements.toastContainer) return;
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      elements.toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 220);
      }, 3200);
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return value
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function loadEvents() {
      state.isLoading = true;
      elements.tableBody.innerHTML = `
        <tr><td colspan="6" class="empty-state">Loading eventsâ€¦</td></tr>
      `;
      elements.detailPanel.style.display = 'none';

      try {
        const response = await apiFetch('/api/admin/events');
        if (!response.ok) {
          throw new Error(`Failed with status ${response.status}`);
        }
        const data = await response.json();
        state.events = (data.events || []).map(mapEventRow);
        applyFilters();
      } catch (error) {
        console.error('Failed to load events:', error);
        elements.tableBody.innerHTML = `
          <tr><td colspan="6" class="empty-state">Unable to load events. Please try again later.</td></tr>
        `;
        showToast('Could not load events.', 'error');
      } finally {
        state.isLoading = false;
      }
    }

    function mapEventRow(row = {}) {
      return {
        ...row,
        id: Number(row.id),
        flag_count: Number(row.flag_count ?? row.flags ?? 0),
        is_flagged:
          row.is_flagged !== undefined
            ? Boolean(row.is_flagged)
            : Number(row.flag_count ?? row.flags ?? 0) > 0,
        moderation_status: (row.moderation_status || row.status || 'pending').toLowerCase(),
      };
    }

    function applyFilters() {
      const searchTerm = (elements.searchInput.value || '').trim().toLowerCase();

      state.filtered = state.events.filter((event) => {
        if (state.filter === 'flagged' && !event.is_flagged) return false;
        if (state.filter === 'pending' && event.moderation_status !== 'pending') return false;

        if (!searchTerm) return true;
        return [
          event.title,
          event.location,
          event.category,
          event.organizer_name,
          event.organization,
          event.moderation_status,
        ]
          .filter(Boolean)
          .some((value) => value.toString().toLowerCase().includes(searchTerm));
      });

      renderTable();
    }

    function renderTable() {
      if (!state.filtered.length) {
        elements.tableBody.innerHTML = `
          <tr><td colspan="6" class="empty-state">No events match the current filters.</td></tr>
        `;
        elements.detailPanel.style.display = 'none';
        state.selectedId = null;
        return;
      }

      const rows = state.filtered
        .map((event) => {
          const { id, title, event_date, event_time, location, moderation_status, is_flagged, flag_count, organizer_name } = event;
          const dateLabel = formatEventDate(event_date, event_time);
          const statusLabel = renderStatusPill(moderation_status, is_flagged);
          const flagsLabel = flag_count > 0 ? `${flag_count}` : '0';

          return `
            <tr data-event-id="${id}" class="${state.selectedId === id ? 'is-selected' : ''}">
              <td>
                <div class="table-primary">${escapeHtml(title)}</div>
                <div class="small-muted">${escapeHtml(organizer_name || 'Unassigned')}</div>
              </td>
              <td>${dateLabel}</td>
              <td>${escapeHtml(location || 'TBD')}</td>
              <td>${statusLabel}</td>
              <td style="font-weight:600; color:${flag_count > 0 ? '#b91c1c' : '#64748b'};">${flagsLabel}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-secondary btn-sm" data-action="view">Details</button>
                </div>
              </td>
            </tr>
          `;
        })
        .join('');

      elements.tableBody.innerHTML = rows;
      if (state.selectedId) {
        const selected = state.events.find((evt) => evt.id === state.selectedId);
        if (selected) {
          highlightSelectedRow();
        } else {
          clearDetailPanel();
        }
      }
    }

    function renderStatusPill(status, flagged) {
      const baseClass = status || 'pending';
      const label = formatStatusLabel(status, flagged);
      const flaggedClass = flagged && status !== 'rejected' ? ' flagged' : '';
      return `<span class="status-pill ${baseClass}${flaggedClass}">${label}</span>`;
    }

    function formatStatusLabel(status, flagged) {
      const value = (status || 'pending').toLowerCase();
      if (value === 'approved') return flagged ? 'Approved Â· Flagged' : 'Approved';
      if (value === 'rejected') return 'Rejected';
      return flagged ? 'Pending Â· Flagged' : 'Pending Review';
    }

    function formatEventDate(date, time) {
      const formattedDate = formatDate(date);
      const formattedTime = formatTime(time);
      if (formattedDate && formattedTime) return `${formattedDate} Â· ${formattedTime}`;
      return formattedDate || formattedTime || 'TBD';
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return dateString;
      return new Intl.DateTimeFormat('en-CA', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
      }).format(date);
    }

    function formatTime(timeString) {
      if (!timeString) return '';
      const [hour = '0', minute = '0'] = timeString.split(':');
      const date = new Date();
      date.setHours(Number(hour), Number(minute));
      return new Intl.DateTimeFormat('en-CA', {
        hour: 'numeric',
        minute: '2-digit',
      }).format(date);
    }

    function highlightSelectedRow() {
      const rows = elements.tableBody.querySelectorAll('tr[data-event-id]');
      rows.forEach((row) => {
        const rowId = Number(row.dataset.eventId);
        row.classList.toggle('is-selected', rowId === state.selectedId);
      });
    }

    function selectEvent(event) {
      state.selectedId = event.id;
      highlightSelectedRow();
      populateDetailPanel(event);
    }

    function populateDetailPanel(event) {
      elements.detailPanel.style.display = 'flex';
      elements.detailTitle.textContent = event.title || 'Event Details';
      elements.detailSubtitle.textContent = formatEventDate(event.event_date, event.event_time);
      elements.detailOrganizer.textContent = event.organizer_name || 'Unassigned';
      elements.detailStatus.textContent = formatStatusLabel(event.moderation_status, event.is_flagged);
      elements.detailCategory.textContent = event.category || 'â€”';
      elements.detailTickets.textContent = `${event.tickets_available ?? 0} / ${event.capacity ?? 0}`;
      elements.detailPrice.textContent = formatCurrency(event.price);
      elements.detailFlags.textContent = event.flag_count ?? 0;
      elements.detailDescription.textContent = event.description || 'No description provided.';

      elements.detailGrid.style.display = 'grid';
      elements.detailDescriptionCard.style.display = 'block';
      elements.detailActions.style.display = 'flex';
    }

    function formatCurrency(amount) {
      const value = Number(amount) || 0;
      if (value === 0) return 'Free';
      return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: 'CAD',
      }).format(value);
    }

    function clearDetailPanel() {
      elements.detailPanel.style.display = 'none';
      state.selectedId = null;
      highlightSelectedRow();
    }

    function openEditDialog() {
      if (!state.selectedId) {
        showToast('Select an event first.', 'error');
        return;
      }
      const event = state.events.find((evt) => evt.id === state.selectedId);
      if (!event) return;

      elements.editTitle.value = event.title || '';
      elements.editDescription.value = event.description || '';
      elements.editLocation.value = event.location || '';
      elements.editStatus.value = event.moderation_status || 'pending';

      elements.editDialog.showModal();
    }

    function closeEditDialog() {
      elements.editDialog.close();
      elements.editForm.reset();
    }

    async function handleEditSubmit(event) {
      event.preventDefault();
      if (!state.selectedId) {
        showToast('Select an event first.', 'error');
        return;
      }

      const payload = {
        title: elements.editTitle.value.trim(),
        description: elements.editDescription.value.trim(),
        location: elements.editLocation.value.trim(),
        moderation_status: elements.editStatus.value,
      };

      try {
        const response = await apiFetch(`/api/admin/events/${state.selectedId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok || data?.success === false) {
          throw new Error(data?.error || data?.message || 'Failed to update event.');
        }

        showToast(data?.message || 'Event updated successfully.');
        closeEditDialog();
        await loadEvents();
        const refreshed = state.events.find((evt) => evt.id === state.selectedId);
        if (refreshed) {
          selectEvent(refreshed);
        }
      } catch (error) {
        console.error('Edit failed:', error);
        showToast(error.message || 'Unable to update event.', 'error');
      }
    }

    function openDeleteDialog() {
      if (!state.selectedId) {
        showToast('Select an event first.', 'error');
        return;
      }
      const event = state.events.find((evt) => evt.id === state.selectedId);
      if (event) {
        elements.deletePrompt.textContent = `Delete â€œ${event.title}â€? This action cannot be undone.`;
      }
      elements.deleteDialog.showModal();
    }

    function closeDeleteDialog() {
      elements.deleteDialog.close();
    }

    async function handleDeleteSubmit(event) {
      event.preventDefault();
      if (!state.selectedId) {
        showToast('Select an event first.', 'error');
        return;
      }
      const targetId = state.selectedId;
      try {
        const response = await apiFetch(`/api/admin/events/${targetId}`, {
          method: 'DELETE',
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok || data?.success === false) {
          throw new Error(data?.error || data?.message || 'Failed to delete event.');
        }

        showToast(data?.message || 'Event deleted.');
        closeDeleteDialog();
        state.selectedId = null;
        await loadEvents();
      } catch (error) {
        console.error('Delete failed:', error);
        showToast(error.message || 'Unable to delete event.', 'error');
      }
    }

    function bindUI() {
      let searchTimer = null;
      elements.searchInput.addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(applyFilters, 200);
      });

      elements.refreshBtn.addEventListener('click', loadEvents);

      elements.filterButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const nextFilter = button.dataset.filter || 'all';
          if (state.filter === nextFilter) return;
          state.filter = nextFilter;
          elements.filterButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
          applyFilters();
        });
      });

      elements.tableBody.addEventListener('click', (event) => {
        const row = event.target.closest('tr[data-event-id]');
        if (!row) return;
        const eventId = Number(row.dataset.eventId);
        const selected = state.events.find((entry) => entry.id === eventId);
        if (!selected) return;

        const actionButton = event.target.closest('button[data-action]');
        if (actionButton && actionButton.dataset.action === 'view') {
          selectEvent(selected);
          return;
        }

        selectEvent(selected);
      });

      elements.openEditBtn.addEventListener('click', openEditDialog);
      elements.openDeleteBtn.addEventListener('click', openDeleteDialog);

      elements.editForm.addEventListener('submit', handleEditSubmit);
      elements.editForm.addEventListener('click', (event) => {
        if (event.target.closest('[data-action="close"]')) {
          event.preventDefault();
          closeEditDialog();
        }
      });
      elements.editDialog.addEventListener('cancel', (event) => {
        event.preventDefault();
        closeEditDialog();
","]} to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch to=functions.apply_patch ea to=functions.apply_patch to=functions.apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch à´¨àµ‡à´Ÿà´¿ to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch to=functions_apply_patch (stop due to huge). 
</body>
</html>
