<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - ConEvents</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        .profile-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-md);
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .profile-row {
            display: flex;
            flex-direction: column;
            gap: .25rem;
            margin-bottom: .5rem;
        }

        .profile-row input {
            padding: 10px 12px;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .tickets-section .card {
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-logo">üé´ ConEvents</a>
            <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="browse.html">Browse</a></li>
                <li><a href="my-tickets.html">My Tickets</a></li>
                <li id="authLinks"><a href="login.html" class="btn btn-secondary btn-sm">Login</a></li>
                <li id="userLinks" style="display:none;"><span id="welcomeMessage"></span><button onclick="logout()"
                        class="btn btn-secondary btn-sm">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="margin-top:2rem;">
        <h1>My Profile</h1>

        <div class="profile-card">
            <form id="profileForm" class="profile-grid">
                <div>
                    <div class="profile-row">
                        <label for="name">Name</label>
                        <input id="name" name="name" type="text" placeholder="Your name" />
                    </div>
                    <div class="profile-row">
                        <label for="email">Email</label>
                        <input id="email" name="email" type="email" disabled />
                    </div>
                    <div class="profile-row">
                        <label for="profile_pic_url">Profile Picture URL</label>
                        <input id="profile_pic_url" name="profile_pic_url" type="text" placeholder="https://..." />
                    </div>
                    <button class="btn btn-primary" type="submit">Save</button>
                </div>
                <div style="text-align:center;">
                    <img id="avatar" src="" alt="avatar"
                        style="width:160px;height:160px;border-radius:50%;object-fit:cover;border:2px solid #eee;" />
                </div>
            </form>
        </div>

        <h2 style="margin-top:2rem;">Your Recent Tickets</h2>
        <div id="ticketsList" class="grid grid-3 tickets-section"></div>
    </div>

    <script type="module">
        import { generateGoogleCalendarURL } from './utils/calendar.js';

        async function loadProfile() {
            const user = localStorage.getItem('user');
            if (!user) { window.location.href = 'login.html'; return; }
            const u = JSON.parse(user);
            document.getElementById('authLinks').style.display = 'none';
            const userLinks = document.getElementById('userLinks');
            userLinks.style.display = 'flex'; userLinks.style.gap = '1rem';
            document.getElementById('welcomeMessage').textContent = `Welcome, ${u.name}!`;

            // Load server profile
            const res = await fetch('http://localhost:3000/api/auth/profile', { credentials: 'include' });
            if (!res.ok) { return; }
            const data = await res.json();
            const p = data.user || {};
            document.getElementById('name').value = p.name || u.name || '';
            document.getElementById('email').value = p.email || u.email || '';
            document.getElementById('profile_pic_url').value = p.profile_pic_url || '';
            document.getElementById('avatar').src = p.profile_pic_url || 'https://via.placeholder.com/160?text=Profile';
        }

        async function loadTickets() {
            const res = await fetch('http://localhost:3000/api/tickets', { credentials: 'include' });
            const data = await res.json();
            const list = document.getElementById('ticketsList');
            list.innerHTML = '';
            if (!data.success || data.count === 0) {
                list.innerHTML = '<p class="text-muted">No recent tickets.</p>';
                return;
            }
            data.tickets.forEach(t => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
          <div class="card-header">
            <h3 class="card-title">${t.title}</h3>
            <p class="card-subtitle">Code: <strong>${t.qr_code}</strong></p>
          </div>
          <div class="card-body">
            <p>üìÖ ${t.event_date} ‚è∞ ${String(t.event_time).slice(0, 5)}</p>
            <p>üìç ${t.location}</p>
            <button class="btn btn-primary add-calendar" 
              data-title="${t.title}" 
              data-description="${t.description || ''}"
              data-location="${t.location}"
              data-start="${t.event_date}T${String(t.event_time).slice(0, 5)}:00"
              data-end="${t.event_date}T${String(t.event_time).slice(0, 5)}:00">
              üìÖ Add to Google Calendar
            </button>
          </div>`;
                list.appendChild(card);
            });
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.add-calendar');
            if (!btn) return;
            const ev = {
                title: btn.dataset.title,
                description: btn.dataset.description,
                location: btn.dataset.location,
                start: btn.dataset.start,
                end: btn.dataset.end
            };
            const url = generateGoogleCalendarURL(ev);
            window.open(url, '_blank');
        });

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const profile_pic_url = document.getElementById('profile_pic_url').value.trim();
            const res = await fetch('http://localhost:3000/api/auth/profile', {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                body: JSON.stringify({ name, profile_pic_url })
            });
            if (res.ok) { alert('Profile updated'); loadProfile(); }
            else { alert('Failed to update profile'); }
        });

        window.logout = async function logout() {
            try {
                await fetch('http://localhost:3000/api/auth/logout', { method: 'POST', credentials: 'include' });
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            } catch (e) { }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await loadTickets();
        });
    </script>
</body>

</html>