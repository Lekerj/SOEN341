<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Organizer Authorization - ConEvents</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        .request-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .request-header {
            background: linear-gradient(135deg, #912338 0%, #6b2c91 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(145, 35, 56, 0.2);
            margin-bottom: 2rem;
            text-align: center;
        }

        .request-header h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem;
            font-weight: 800;
        }

        .request-header p {
            margin: 0;
            opacity: 0.95;
        }

        .status-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.null {
            background: #e5e7eb;
            color: #374151;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.refused {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #912338;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .request-container .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .request-container .btn-primary {
            background: #912338;
            color: white;
        }

        .request-container .btn-primary:hover {
            background: #7a1d2e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(145, 35, 56, 0.3);
        }

        .request-container .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .request-container .btn-secondary:hover {
            background: #d1d5db;
        }

        .request-container .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .hidden {
            display: none;
        }

        .info-box {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: #4b5563;
        }

        .request-history {
            margin-top: 2rem;
        }

        .request-history h3 {
            margin-bottom: 1rem;
            color: #111827;
        }

        .history-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #e5e7eb;
        }

        .history-item.pending {
            border-left-color: #fbbf24;
        }

        .history-item.refused {
            border-left-color: #ef4444;
        }

        .history-item.approved {
            border-left-color: #10b981;
        }

        .history-meta {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .request-container {
                padding: 1rem;
            }

            .request-header {
                padding: 1.5rem;
            }

            .request-header h1 {
                font-size: 1.5rem;
            }

            .form-card,
            .status-card {
                padding: 1.5rem;
            }

            .radio-group {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar (match homepage style) -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-logo">üé´ ConEvents</a>
            <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="browse.html">Browse</a></li>
                <li><a href="about.html">About</a></li>
                <li id="adminMenu" class="dropdown" style="display:none;">
                    <a href="#" class="dropdown-toggle">Admin</a>
                    <ul class="dropdown-menu">
                        <li><a href="admin-moderation.html">Event Moderation</a></li>
                    </ul>
                </li>
                <li id="organizerMenu" class="dropdown" style="display:none;">
                    <a href="#" class="dropdown-toggle">Organizer</a>
                    <ul class="dropdown-menu">
                        <li><a href="organizer-dashboard.html">My Dashboard</a></li>
                        <li><a href="organizer-create-event.html">Create Event</a></li>
                        <li><a href="organizer-edit-event.html?eventId=X">Edit Event</a></li>
                        <li><a href="organizer-analytics.html?eventId=X">Event Analytics</a></li>
                        <li><a href="organizer-scanner.html">QR Scanner</a></li>
                    </ul>
                </li>
                <li id="organizerRequestLink" style="display:none;"><a href="organizer-request.html">üéØ Become Organizer</a></li>
                <li><a href="profile.html">Profile</a></li>
                <li id="authLinks">
                    <a href="login.html" class="btn btn-primary btn-sm">Login</a>
                    <a href="register.html" class="btn btn-primary btn-sm">Sign Up</a>
                </li>
                <li id="userLinks" style="display: none;">
                    <span id="welcomeMessage" class="text-muted"></span>
                    <button class="btn btn-secondary btn-sm">Logout</button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="request-container">
        <div class="request-header">
            <h1>üéØ Organizer Authorization</h1>
            <p>Request access to create and manage events for your organization</p>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Current Status Card -->
        <div class="status-card" id="statusCard">
            <h2 style="margin-top: 0;">Current Status</h2>
            <div id="statusContent">
                <p>Loading your authorization status...</p>
            </div>
        </div>

        <!-- Request Form -->
        <div class="form-card" id="requestForm">
            <h2 style="margin-top: 0;" id="formTitle">Submit Authorization Request</h2>
            
            <div class="info-box">
                <strong>‚ÑπÔ∏è What you need to know:</strong><br>
                ‚Ä¢ You can join an existing organization or create a new one<br>
                ‚Ä¢ Your request will be reviewed by an administrator<br>
                ‚Ä¢ Once approved, you'll be able to create and manage events<br>
                ‚Ä¢ You can modify your request while it's pending
            </div>

            <form id="authRequestForm">
                <!-- Organization Type -->
                <div class="form-group">
                    <label>Organization Type</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="joinExisting" name="orgType" value="existing" checked />
                            <label for="joinExisting" style="margin: 0;">Join Existing Organization</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="createNew" name="orgType" value="new" />
                            <label for="createNew" style="margin: 0;">Create New Organization</label>
                        </div>
                    </div>
                </div>

                <!-- Existing Organization Selection -->
                <div class="form-group" id="existingOrgGroup">
                    <label for="organizationSelect">Select Organization</label>
                    <select id="organizationSelect" name="organization_id">
                        <option value="">Loading organizations...</option>
                    </select>
                </div>

                <!-- New Organization Fields -->
                <div class="form-group hidden" id="newOrgGroup">
                    <label for="newOrgName">Organization Name *</label>
                    <input 
                        type="text" 
                        id="newOrgName" 
                        name="new_organization_name" 
                        placeholder="e.g., Chess Club, Robotics Society" 
                        maxlength="100"
                    />
                </div>

                <div class="form-group hidden" id="newOrgCategoryGroup">
                    <label for="newOrgCategory">Category *</label>
                    <select id="newOrgCategory" name="category">
                        <option value="">Select a category</option>
                        <option value="sports">Sports</option>
                        <option value="academic">Academic</option>
                        <option value="social">Social</option>
                        <option value="club">Club</option>
                    </select>
                </div>

                <!-- Details -->
                <div class="form-group">
                    <label for="details">Additional Details (Optional)</label>
                    <textarea 
                        id="details" 
                        name="details" 
                        placeholder="Tell us why you want to organize events for this organization, your experience, or any other relevant information..."
                    ></textarea>
                </div>

                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Submit Request
                    </button>
                </div>
            </form>
        </div>

        <!-- Request History -->
        <div class="request-history" id="requestHistory" style="display: none;">
            <h3>Request History</h3>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- Footer (standard across site) -->
    <footer class="footer">
      <div class="footer-links">
        <a href="about.html">About Us</a>
        <a href="browse.html">Events</a>
        <a href="privacy.html">Privacy Policy</a>
        <a href="terms.html">Terms of Service</a>
        <a href="contact.html">Contact</a>
      </div>
      <p>&copy; 2025 ConEvents - Concordia University. All rights reserved.</p>
    </footer>

    <script type="module">
        import { getApiBase } from './utils/api.js';
        import { setupNavbar } from './utils/navbar.js';
        window.addEventListener('DOMContentLoaded', setupNavbar);

        let currentUser = null;
        let currentStatus = null;
        let pendingRequestId = null;
        let organizations = [];

        // Initialize page
        async function init() {
            try {
                await loadUser();
                await loadOrganizations();
                await loadStatus();
                await loadRequestHistory();
                setupEventListeners();
            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Failed to load page. Please refresh.', 'error');
            }
        }

        // Load current user
        async function loadUser() {
            try {
                const response = await fetch(`${getApiBase()}/api/auth/profile`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const data = await response.json();
                currentUser = data.user;

                // Check if user is organizer
                if (currentUser.role !== 'organizer') {
                    showAlert('Access denied. Only organizer accounts can submit authorization requests.', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Failed to load user:', error);
                window.location.href = 'login.html';
            }
        }

        // Navigation is handled by setupNavbar()

        // Load organizations
        async function loadOrganizations() {
            try {
                const response = await fetch(`${getApiBase()}/api/organizer/organizations`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    organizations = data.organizations || [];
                    populateOrganizationSelect();
                }
            } catch (error) {
                console.error('Failed to load organizations:', error);
            }
        }

        // Populate organization dropdown
        function populateOrganizationSelect() {
            const select = document.getElementById('organizationSelect');
            select.innerHTML = '<option value="">-- Select an organization --</option>';
            
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = `${org.name} (${org.category})`;
                select.appendChild(option);
            });
        }

        // Load current status
        async function loadStatus() {
            try {
                const response = await fetch(`${getApiBase()}/api/organizer/status`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentStatus = data.status;
                    updateStatusDisplay();
                    updateFormState();
                }
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        // Update status display
        function updateStatusDisplay() {
            const statusContent = document.getElementById('statusContent');
            const authStatus = currentStatus.organizer_auth_status;
            
            let badgeClass = authStatus === 'null' ? 'null' : authStatus;
            let statusText = authStatus === 'null' ? 'Not Requested' : authStatus.charAt(0).toUpperCase() + authStatus.slice(1);
            
            let statusHTML = `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <span class="status-badge ${badgeClass}">${statusText}</span>
                    ${currentStatus.organization_name ? `<span style="color: #6b7280;">Organization: <strong>${currentStatus.organization_name}</strong></span>` : ''}
                </div>
            `;

            if (authStatus === 'null') {
                statusHTML += `<p style="color: #6b7280; margin: 0;">You haven't submitted an authorization request yet. Fill out the form below to get started.</p>`;
            } else if (authStatus === 'pending') {
                statusHTML += `<p style="color: #92400e; margin: 0;">‚è≥ Your request is under review by an administrator. You can modify it using the form below.</p>`;
            } else if (authStatus === 'refused') {
                statusHTML += `<p style="color: #991b1b; margin: 0;">‚ùå Your request was refused. You can submit a new request below.</p>`;
            } else if (authStatus === 'approved') {
                statusHTML += `
                    <p style="color: #065f46; margin: 0 0 1rem 0;">‚úÖ Your organizer authorization has been approved! You can now create and manage events.</p>
                    <a href="organizer-dashboard.html" class="btn btn-primary">Go to Dashboard</a>
                `;
            }

            statusContent.innerHTML = statusHTML;
        }

        // Update form state based on status
        function updateFormState() {
            const form = document.getElementById('requestForm');
            const formTitle = document.getElementById('formTitle');
            const submitBtn = document.getElementById('submitBtn');
            const authStatus = currentStatus.organizer_auth_status;

            if (authStatus === 'approved') {
                form.style.display = 'none';
                return;
            }

            if (authStatus === 'pending') {
                formTitle.textContent = 'Modify Your Request';
                submitBtn.textContent = 'Update Request';
            } else {
                formTitle.textContent = authStatus === 'refused' ? 'Submit New Request' : 'Submit Authorization Request';
                submitBtn.textContent = 'Submit Request';
            }
        }

        // Load request history
        async function loadRequestHistory() {
            try {
                const response = await fetch(`${getApiBase()}/api/organizer/requests`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const requests = data.requests || [];
                    
                    if (requests.length > 0) {
                        displayRequestHistory(requests);
                        
                        // Find pending request ID
                        const pending = requests.find(r => r.status === 'pending');
                        if (pending) {
                            pendingRequestId = pending.id;
                            // Pre-fill form with pending request data
                            prefillForm(pending);
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load request history:', error);
            }
        }

        // Pre-fill form with pending request data
        function prefillForm(request) {
            if (request.organization_id) {
                document.getElementById('joinExisting').checked = true;
                document.getElementById('organizationSelect').value = request.organization_id;
                toggleOrganizationType();
            } else if (request.request_type === 'create') {
                document.getElementById('createNew').checked = true;
                toggleOrganizationType();
            }
            
            if (request.details) {
                document.getElementById('details').value = request.details;
            }
        }

        // Display request history
        function displayRequestHistory(requests) {
            const historySection = document.getElementById('requestHistory');
            const historyContent = document.getElementById('historyContent');
            
            historyContent.innerHTML = requests.map(req => {
                const date = new Date(req.created_at).toLocaleDateString();
                const updated = req.updated_at !== req.created_at ? ` (Updated: ${new Date(req.updated_at).toLocaleDateString()})` : '';
                
                return `
                    <div class="history-item ${req.status}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>${req.organization_name || 'Organization'}</strong>
                                <span class="status-badge ${req.status}" style="margin-left: 0.5rem;">${req.status}</span>
                            </div>
                        </div>
                        ${req.details ? `<p style="margin: 0.5rem 0; color: #4b5563;">${req.details}</p>` : ''}
                        ${req.refusal_reason ? `<p style="margin: 0.5rem 0; color: #991b1b;"><strong>Refusal Reason:</strong> ${req.refusal_reason}</p>` : ''}
                        <div class="history-meta">Submitted: ${date}${updated}</div>
                    </div>
                `;
            }).join('');
            
            historySection.style.display = 'block';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Organization type toggle
            document.querySelectorAll('input[name="orgType"]').forEach(radio => {
                radio.addEventListener('change', toggleOrganizationType);
            });

            // Form submission
            document.getElementById('authRequestForm').addEventListener('submit', handleFormSubmit);
        }

        // Toggle organization type fields
        function toggleOrganizationType() {
            const orgType = document.querySelector('input[name="orgType"]:checked').value;
            const existingGroup = document.getElementById('existingOrgGroup');
            const newOrgGroup = document.getElementById('newOrgGroup');
            const newOrgCategoryGroup = document.getElementById('newOrgCategoryGroup');

            if (orgType === 'existing') {
                existingGroup.classList.remove('hidden');
                newOrgGroup.classList.add('hidden');
                newOrgCategoryGroup.classList.add('hidden');
            } else {
                existingGroup.classList.add('hidden');
                newOrgGroup.classList.remove('hidden');
                newOrgCategoryGroup.classList.remove('hidden');
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();

            const orgType = document.querySelector('input[name="orgType"]:checked').value;
            const submitBtn = document.getElementById('submitBtn');
            
            // Validate
            if (orgType === 'existing') {
                const orgId = document.getElementById('organizationSelect').value;
                if (!orgId) {
                    showAlert('Please select an organization', 'error');
                    return;
                }
            } else {
                const orgName = document.getElementById('newOrgName').value.trim();
                const category = document.getElementById('newOrgCategory').value;
                
                if (!orgName) {
                    showAlert('Please enter an organization name', 'error');
                    return;
                }
                if (!category) {
                    showAlert('Please select a category', 'error');
                    return;
                }
            }

            // Prepare request data
            const requestData = {
                details: document.getElementById('details').value.trim()
            };

            if (orgType === 'existing') {
                requestData.organization_id = parseInt(document.getElementById('organizationSelect').value);
            } else {
                requestData.new_organization_name = document.getElementById('newOrgName').value.trim();
                requestData.category = document.getElementById('newOrgCategory').value;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                let response;
                
                if (pendingRequestId) {
                    // Modify existing pending request
                    response = await fetch(`${getApiBase()}/api/organizer/request/${pendingRequestId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(requestData)
                    });
                } else {
                    // Submit new request
                    response = await fetch(`${getApiBase()}/api/organizer/request`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(requestData)
                    });
                }

                const data = await response.json();

                if (response.ok) {
                    showAlert(data.message || 'Request submitted successfully!', 'success');
                    
                    // Reload status and history
                    await loadStatus();
                    await loadRequestHistory();
                    
                    // Reset form
                    document.getElementById('authRequestForm').reset();
                    toggleOrganizationType();
                } else {
                    showAlert(data.error || 'Failed to submit request', 'error');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showAlert('Failed to submit request. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = pendingRequestId ? 'Update Request' : 'Submit Request';
            }
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
