<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizer â€¢ QR Scanner</title>

  <link rel="stylesheet" href="./styles.css" />
  <!-- jsQR for client-side QR decoding (global jsQR) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <!-- Mirror organizer-create-event: import getApiBase and bootstrap profile/session -->
  <script type="module">
    import { getApiBase } from './utils/api.js';

    // Show/hide navbar like create-event does
    window.addEventListener('DOMContentLoaded', async () => {
      const stored = localStorage.getItem('user');
      if (!stored) return;

      try {
        const resp = await fetch(`${getApiBase()}/api/auth/profile`, { credentials: 'include' });
        const authLinks = document.getElementById('authLinks');
        const userLinks = document.getElementById('userLinks');
        const welcome = document.getElementById('welcomeMessage');

        if (resp.ok) {
          const user = JSON.parse(stored);
          if (authLinks) authLinks.style.display = 'none';
          if (userLinks) {
            userLinks.style.display = 'flex';
            userLinks.style.gap = '1rem';
            userLinks.style.alignItems = 'center';
          }
          if (welcome && user?.name) welcome.textContent = `Welcome, ${user.name}!`;
        } else if (resp.status === 401) {
          localStorage.removeItem('user');
        }
      } catch (error) {
        console.warn('Profile check failed:', error);
        localStorage.removeItem('user');
      }
    });

    // Same logout behavior as organizer-create-event
    window.logout = async function logout() {
      try {
        const resp = await fetch(`${getApiBase()}/api/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
        if (resp.ok) {
          localStorage.removeItem('user');
          window.location.href = 'index.html';
        } else {
          alert('Logout failed. Please try again.');
        }
      } catch (error) {
        console.warn('Logout failed:', error);
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      }
    };
  </script>

  <style>
    /* Minimal helpers (your design system handles most styling) */
    .stack {
      display: grid;
      gap: var(--gap, 1rem);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .row--2 {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: var(--surface, #fff);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 0.75rem;
      padding: 1rem;
    }

    .muted {
      color: var(--muted, #6b7280);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.875rem;
    }

    .badge--ok {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .badge--warn {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .badge--err {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .input,
    .select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 0.5rem;
      background: var(--surface, #fff);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 0;
    }

    .header__title {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px dashed var(--border, #e5e7eb);
    }

    .list li:last-child {
      border-bottom: none;
    }

    .vis {
      min-height: 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .inline {
      display: flex;
      gap: .5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .small {
      font-size: .875rem;
    }
  </style>
</head>

<body>
  <div class="container stack" style="--gap: 1.25rem; max-width: 1000px; margin: 0 auto; padding: 1rem;">

    <!-- Navigation (same structure used across pages) -->
    <nav class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-logo">ðŸŽ« ConEvents</a>
        <ul class="navbar-menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="index.html#events">Events</a></li>
          <li><a href="about.html">About</a></li>
          <li id="authLinks">
            <a href="login.html" class="btn btn-primary btn-sm">Login</a>
            <a href="register.html" class="btn btn-primary btn-sm">Sign Up</a>
          </li>
          <li id="userLinks" style="display:none;">
            <span id="welcomeMessage" class="text-muted"></span>
            <button onclick="logout()" class="btn btn-secondary btn-sm">Logout</button>
          </li>
        </ul>
      </div>
    </nav>


    <!-- Header -->
    <header class="header">
      <div class="stack" style="--gap: 0.25rem;">

        <!-- Event picker -->
        <div class="inline small">
          <label for="eventSelect" class="muted">Event:</label>
          <select id="eventSelect" class="select" style="max-width: 420px;">
            <option value="" selected disabled>Loading your eventsâ€¦</option>
          </select>
          <div class="muted">
            <strong id="eventTitle">â€”</strong>
            <span class="muted">â€¢</span>
            <span id="eventDate">â€”</span>
          </div>
        </div>

        <!-- Staff key (optional) -->
        <div class="inline small">
          <input id="staffKey" class="input" type="password" placeholder="Enter staff key for check-in"
            style="max-width:260px;">
          <button class="btn btn--ghost small" id="saveStaffKey">Save</button>
          <span id="staffKeySaved" class="muted" style="display:none;">Saved</span>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="btnClear">Clear</button>
      </div>
    </header>

    <!-- Upload / Manual -->
    <section class="row row--2">
      <div class="card stack" style="--gap: 0.75rem;">
        <h2 style="font-size: 1rem; font-weight: 600;">Upload QR Image</h2>
        <p class="muted small">Upload a QR image; weâ€™ll decode and verify it automatically.</p>
        <input class="input" type="file" id="qrFile" accept="image/*" />
        <canvas id="qrCanvas" hidden></canvas>
        <img id="preview" alt="Preview" style="max-width: 100%; border-radius: 0.5rem; display:none;" />
      </div>

      <div class="card stack" style="--gap: 0.75rem;">
        <h2 style="font-size: 1rem; font-weight: 600;">Manual Ticket Entry</h2>
        <p class="muted small">Paste the full ticket URL or the ticket code itself.</p>
        <div class="stack" style="--gap: 0.5rem;">
          <input class="input" type="text" id="manualCode" placeholder="https://.../api/tickets/qr/ABC123 or ABC123"
            autocomplete="one-time-code" />
          <div class="toolbar">
            <button class="btn" id="btnValidate">Verify</button>
            <button class="btn btn--ghost" id="btnPaste">Paste</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Result & Stats -->
    <section class="row row--2">
      <div class="card stack" style="--gap: 0.75rem;">
        <h2 class="small" style="font-weight: 600;">Result</h2>
        <div class="vis">
          <span id="resultBadge" class="badge badge--warn">Waiting for inputâ€¦</span>
          <div class="muted" id="resultMeta">No ticket processed yet.</div>
        </div>
        <dl class="stack small" style="--gap: 0.25rem; margin: 0;">
          <div class="inline"><span class="muted">Ticket:</span><strong id="resTicket">â€”</strong></div>
          <div class="inline"><span class="muted">Name:</span><strong id="resName">â€”</strong></div>
          <div class="inline"><span class="muted">Email:</span><strong id="resEmail">â€”</strong></div>
          <div class="inline"><span class="muted">Checked-in:</span><strong id="resChecked">â€”</strong></div>
        </dl>
        <div class="toolbar">
          <button class="btn" id="btnCheckIn">Check In</button>
        </div>
      </div>

      <div class="card stack" style="--gap: 0.75rem;">
        <h2 class="small" style="font-weight: 600;">Running Statistics</h2>
        <ul class="list" aria-live="polite">
          <li><span class="muted">Total Verified</span><strong id="statTotal">0</strong></li>
          <li><span class="muted">Checked-in</span><strong id="statChecked">0</strong></li>
          <li><span class="muted">Already Checked</span><strong id="statAlready">0</strong></li>
          <li><span class="muted">Invalid</span><strong id="statInvalid">0</strong></li>
        </ul>
      </div>
    </section>
  </div>

  <!-- Scanner logic that matches create-event API handling -->
  <script type="module">
    import { getApiBase } from './utils/api.js';

    // ====== Helpers matching organizer-create-event ======
    function getAuthToken() {
      const stored = localStorage.getItem('authToken');
      if (stored) return stored;
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user && user.token) return user.token;
      } catch (_) { }
      return '';
    }
    function authHeaders(base = {}) {
      const token = getAuthToken();
      return token ? { ...base, Authorization: `Bearer ${token}` } : base;
    }

    // ====== Elements ======
    const CHECK_IN_HEADER = 'X-Staff-Key';

    const eventSelect = document.getElementById('eventSelect');
    const eventTitleEl = document.getElementById('eventTitle');
    const eventDateEl = document.getElementById('eventDate');

    const staffKeyEl = document.getElementById('staffKey');
    const saveStaffKeyBtn = document.getElementById('saveStaffKey');
    const staffKeySaved = document.getElementById('staffKeySaved');

    const manualCode = document.getElementById('manualCode');
    const btnValidate = document.getElementById('btnValidate');
    const btnPaste = document.getElementById('btnPaste');
    const btnClear = document.getElementById('btnClear');
    const btnCheckIn = document.getElementById('btnCheckIn');

    const fileInput = document.getElementById('qrFile');
    const preview = document.getElementById('preview');
    const qrCanvas = document.getElementById('qrCanvas');
    const ctx = qrCanvas.getContext('2d');

    const resBadge = document.getElementById('resultBadge');
    const resMeta = document.getElementById('resultMeta');
    const resTicket = document.getElementById('resTicket');
    const resName = document.getElementById('resName');
    const resEmail = document.getElementById('resEmail');
    const resChecked = document.getElementById('resChecked');

    const statTotal = document.getElementById('statTotal');
    const statChecked = document.getElementById('statChecked');
    const statAlready = document.getElementById('statAlready');
    const statInvalid = document.getElementById('statInvalid');

    // ====== Utils ======
    function show(el, on = true) { el.style.display = on ? '' : 'none'; }
    function setBadge(kind, text) {
      resBadge.className = 'badge ' + (kind === 'ok' ? 'badge--ok' : kind === 'err' ? 'badge--err' : 'badge--warn');
      resBadge.textContent = text;
    }
    function fmtDate(input) {
      if (!input) return 'â€”';
      const d = new Date(input);
      if (isNaN(d)) return input;
      return d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }
    function parseTicketCode(text) {
      if (!text) return '';
      const m = text.trim().match(/\/api\/tickets\/qr\/([A-Za-z0-9_-]+)/);
      return m ? m[1] : text.trim();
    }

    // ====== Load organizer events (mirror create-event base/middleware) ======
    async function loadOrganizerEvents() {
      try {
        // Organizer's events â€” pick the route your backend exposes.
        // If your backend uses /api/organizer/events for read, reuse it (same as create-event POST base path).
        const resp = await fetch(`${getApiBase()}/api/organizer/events`, {
          credentials: 'include',
          headers: authHeaders({ 'Accept': 'application/json' })
        });
        const data = resp.ok ? await resp.json() : { success: false, events: [] };
        const events = data.success ? data.events : [];
        eventSelect.innerHTML = '';

        if (!Array.isArray(events) || !events.length) {
          eventSelect.innerHTML = '<option value="">No events found</option>';
          eventSelect.disabled = true;
          return;
        }

        const params = new URLSearchParams(location.search);
        const urlEventId = params.get('eventId');

        events.forEach(e => {
          const opt = document.createElement('option');
          opt.value = String(e.id ?? e.event_id ?? e.uuid);
          opt.textContent = e.title ?? e.name ?? 'Untitled event';
          if (urlEventId && String(urlEventId) === opt.value) opt.selected = true;
          eventSelect.appendChild(opt);
        });

        updateSelectedEvent();
      } catch (err) {
        console.warn('Failed to load events', err);
        eventSelect.innerHTML = '<option value="">Unable to load events</option>';
      }
    }

    function updateSelectedEvent() {
      const selectedId = eventSelect.value;
      const selectedText = eventSelect.options[eventSelect.selectedIndex]?.textContent || 'â€”';
      eventTitleEl.textContent = selectedText;

      fetch(`${getApiBase()}/api/events/${selectedId}`, {
        credentials: 'include',
        headers: authHeaders({ 'Accept': 'application/json' })
      })
        .then(r => r.ok ? r.json() : null)
        .then(ev => eventDateEl.textContent = fmtDate(ev?.starts_at ?? ev?.event_date ?? ev?.startsAt ?? null))
        .catch(() => eventDateEl.textContent = 'â€”');
    }

    eventSelect?.addEventListener('change', () => {
      const params = new URLSearchParams(location.search);
      params.set('eventId', eventSelect.value);
      history.replaceState({}, '', location.pathname + '?' + params.toString());
      updateSelectedEvent();
    });

    // ====== Staff key save ======
    saveStaffKeyBtn.addEventListener('click', () => {
      const key = staffKeyEl.value.trim();
      if (!key) return;
      localStorage.setItem('staffKey', key);
      show(staffKeySaved, true);
      setTimeout(() => show(staffKeySaved, false), 1200);
    });

    // Prefill staff key
    (function prefillStaffKey() { const saved = localStorage.getItem('staffKey'); if (saved) staffKeyEl.value = saved; })();

    // ====== QR upload + decode (client-side) ======
    fileInput?.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) { preview.src = ''; show(preview, false); return; }
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const { width, height } = img;
          qrCanvas.width = width; qrCanvas.height = height;
          ctx.drawImage(img, 0, 0);
          const data = ctx.getImageData(0, 0, width, height);
          const result = jsQR(data.data, width, height);
          if (result && result.data) {
            let raw = (result && result.data ? result.data : '').trim();
            let short = raw;

            try {
              const u = new URL(raw);
              // Prefer ?code=... if present
              short = u.searchParams.get('code')
                || (u.pathname.match(/\/api\/tickets\/qr\/([^/]+)/)?.[1])
                || u.pathname.split('/').filter(Boolean).pop(); // last path segment
            } catch {
              // Not a URL string: try regex fallbacks
              short = raw.match(/[?&]code=([^&]+)/)?.[1]
                || raw.match(/\/api\/tickets\/qr\/([^/]+)/)?.[1]
                || raw;
            }

            manualCode.value = short;
            verifyNow();
          } else {
            setBadge('err', 'No QR found');
            resMeta.textContent = 'Unable to decode QR image.';
          }
        };
        img.src = reader.result;
        preview.src = reader.result; show(preview, true);
      };
      reader.readAsDataURL(f);
    });

    btnPaste?.addEventListener('click', async () => {
      try { manualCode.value = (await navigator.clipboard.readText()).trim(); } catch { }
      manualCode.focus();
    });

    // ====== Verify flow (uses same base/middleware as create-event) ======
    btnValidate?.addEventListener('click', () => verifyNow());

    async function verifyNow() {
      const raw = manualCode.value.trim();
      if (!raw) { setBadge('err', 'No input'); resMeta.textContent = 'Paste ticket URL or code.'; return; }
      const code = parseTicketCode(raw);

      setBadge('warn', 'Verifyingâ€¦');
      resMeta.textContent = 'Checking ticket statusâ€¦';

      try {
        const resp = await fetch(`${getApiBase()}/api/tickets/verify`, {
          method: 'POST',
          credentials: 'include',
          headers: authHeaders({ 'Content-Type': 'application/json', 'Accept': 'application/json' }),
          body: JSON.stringify({ ticket_code: code, eventId: eventSelect.value || undefined })
        });

        statTotal.textContent = String(+statTotal.textContent + 1);

        if (!resp.ok) {
          setBadge('err', 'Invalid ticket');
          resMeta.textContent = 'Ticket not found or invalid.';
          statInvalid.textContent = String(+statInvalid.textContent + 1);
          return;
        }

        const data = await resp.json();
        resTicket.textContent = data.code || code;
        resName.textContent = data.attendeeName || data.name || 'â€”';
        resEmail.textContent = data.attendeeEmail || data.email || 'â€”';
        resChecked.textContent = data.checkedIn ? 'Yes' : 'No';

        if (data.checkedIn) {
          setBadge('warn', 'Already checked-in');
          resMeta.textContent = data.message || 'This ticket is already checked in.';
          statAlready.textContent = String(+statAlready.textContent + 1);
        } else {
          setBadge('ok', 'Valid ticket');
          resMeta.textContent = data.message || 'Ready to check in';
        }
      } catch (err) {
        console.error(err);
        setBadge('err', 'Network error');
        resMeta.textContent = 'Please try again.';
      }
    }

    // ====== Check-in (same middleware + optional staff key header) ======
    btnCheckIn?.addEventListener('click', async () => {
      const code = resTicket.textContent;
      if (!code || code === 'â€”') return;

      const staffKey = staffKeyEl.value.trim() || localStorage.getItem('staffKey') || '';
      const baseHeaders = authHeaders({ 'Content-Type': 'application/json', 'Accept': 'application/json' });
      const headers = staffKey ? { ...baseHeaders, [CHECK_IN_HEADER]: staffKey } : baseHeaders;

      setBadge('warn', 'Checking inâ€¦');

      try {
        const resp = await fetch(`${getApiBase()}/api/tickets/check-in`, {
          method: 'POST',
          credentials: 'include',
          headers,
          body: JSON.stringify({ ticket_code: code, eventId: eventSelect.value || undefined })
        });

        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          setBadge('err', 'Check-in failed');
          resMeta.textContent = text || 'Unauthorized or invalid ticket.';
          return;
        }

        const data = await resp.json();
        resChecked.textContent = data.checkedIn ? 'Yes' : 'No';
        setBadge('ok', 'Checked in');
        resMeta.textContent = data.message || 'Attendee checked in successfully';
        statChecked.textContent = String(+statChecked.textContent + 1);
      } catch (err) {
        console.error(err);
        setBadge('err', 'Network error');
        resMeta.textContent = 'Please try again.';
      }
    });

    // ====== Clear ======
    btnClear?.addEventListener('click', () => {
      manualCode.value = '';
      preview.src = ''; show(preview, false);
      resBadge.className = 'badge badge--warn';
      resBadge.textContent = 'Waiting for inputâ€¦';
      resMeta.textContent = 'No ticket processed yet.';
      resTicket.textContent = resName.textContent = resEmail.textContent = resChecked.textContent = 'â€”';
    });

    // ====== Bootstrap events ======
    await loadOrganizerEvents();
  </script>
</body>

</html>